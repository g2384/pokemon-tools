<html>

<head>
    <link href="./css/tom-select.bootstrap5.min.css" rel="stylesheet" />
    <link href="./css/bootstrap.min.css" rel="stylesheet" />
    <link href="./css/pokemon_types.css" rel="stylesheet" />
    <style>
        body {
            padding: 10px;
            margin: 0 auto;
            max-width: 2000px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: rgb(224, 224, 224);
        }

        .img_type {
            height: 20px;
            padding-right: 2px;
        }

        .img_icon {
            height: 20px;
            margin-left: 2px;
        }

        .pokemon_icon {
            height: 40px;
            margin-left: 2px;
        }

        .move {
            padding: 2px;
            border: 1px solid #888;
            margin: 5px 2px;
            display: inline-block;
            min-width: 12em;
        }

        .move-header {
            display: inline-block;
            min-width: 5em;
        }

        .move-tag {
            color: #000;
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            display: inline-block;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 3px;
        }

        .elite-move {
            background-color: #f7f70d;
            border: 1px solid #dfc300;
        }

        .shadow-move {
            background-color: #e1caff;
            border: 1px solid #826eed;
        }

        .purified-move {
            background-color: #d3d3d3;
            border: 1px solid #707070;
        }
    </style>
</head>

<body>
    <h2>PvP Pokemons</h2>
    Get top <input type="number" id="rankings_num" value="50" /> from the ranking list.
    <input type="button" value="Generate" onclick="generateTable()" />
    <div id="results"></div>
    <script>
        let pokemons = [];
        let rankings_great = [];
        let rankings_jungle = [];
        let rankings_spring = [];
        let rankings_ultra = [];
        let rankings_master = [];
        let combatMovesDict = {};

        function generateTable() {
            const namesDict = {};
            const fullNameDict = {};
            let num = document.querySelector("#rankings_num").value;
            console.log(num)
            const rankings = {
                "great": rankings_great,
                "jungle": rankings_jungle,
                "spring": rankings_spring,
                "ultra": rankings_ultra,
                "master": rankings_master
            };
            for (const [key, value] of Object.entries(rankings)) {
                var r = value;
                var minLength = Math.min(num, r.length);
                for (let j = 0; j < minLength; j++) {
                    let name = value[j].speciesName;
                    let speciesName = name;
                    name = name.replace(/\([\w\-%\s']+\)/g, "");
                    name = name.trim();
                    name = name.toUpperCase();
                    fullNameDict[speciesName] = name;
                    if (!namesDict[speciesName]) {
                        namesDict[speciesName] = {};
                    }
                    namesDict[speciesName][`${key}_${j + 1}`] = { "moveset": value[j].moveset, "rank": j + 1 };
                }
            }

            const rows = [];
            for (const [key, value] of Object.entries(namesDict)) {
                var eliteQuickMove = [];
                var eliteChargedMove = [];
                var n = extractForms(key);
                var name = n.name.toUpperCase();
                name = name.replace(/-/g, "_");
                var id = 0;
                for (const p of pokemons) {
                    if (p.templateId.includes(name)) {
                        var ee = p.data?.pokemonSettings?.eliteCinematicMove;
                        if (ee != undefined) {
                            eliteChargedMove = ee;
                        };
                        ee = p.data?.pokemonSettings?.eliteQuickMove;
                        if (ee != undefined) {
                            eliteQuickMove = ee;
                        }
                        var idStr = p.templateId.split("_")[0].replace("V", "");
                        id = parseInt(idStr, 10);
                        break;
                    }
                }
                var form = n.forms[0];
                if (form == undefined) {
                    form = "Normal";
                }
                else if (form == "Shadow") {
                    form = "Normal";
                } else {
                    if (form == "Alolan") {
                        form = "Alola";
                    }
                    form = toTitleCase(form.trim());
                }
                var iconName = getSpriteName(id, form);
                var img = "<img class='pokemon_icon' src='https://raw.githubusercontent.com/PokeMiners/pogo_assets/master/Images/Pokemon/Addressable Assets/" + iconName + "' />";
                rows.push(`<td>${img}${key}</td><td>${getMovesCell(value, eliteQuickMove, eliteChargedMove)}</td>`);
            }
            var html = `<table class='table table-striped align-middle'><tr><th>Pokemon</th><th>Moves</th></tr><tr>${rows.join("</tr><tr>")}</tr></table>`;
            document.querySelector("#results").innerHTML = html;
        }

        function extractForms(str) {
            const formRegex = /\(([^)]+)\)/g;
            const forms = str.match(formRegex) || [];
            const nonFormText = forms.reduce((acc, curr) => acc.replace(curr, ''), str).trim();

            return {
                name: nonFormText,
                forms: forms.map(form => form.slice(1, -1))
            };
        }

        function getSpriteName(id, form) {
            form = form.toLowerCase();
            if (form == "normal") {
                return "pm" + id + ".icon.png";
            }

            return "pm" + id + ".f" + form.toUpperCase() + ".icon.png";
        }

        function toTitleCase(str) {
            // Split the string into an array of words
            const words = str.toLowerCase().split(' ');

            // Capitalize the first letter of each word
            const titleCaseWords = words.map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1);
            });

            // Join the words back into a single string
            const titleCaseString = titleCaseWords.join(' ');

            return titleCaseString;
        }

        function getMovesCell(moves, eliteQuickMove, eliteChargedMove) {
            var strs = [];
            var preMove = "";
            for (const [key, value] of Object.entries(moves)) {
                var move = value.moveset;
                var move1 = getMoveString(move[0], eliteQuickMove, true);
                var move2 = getMoveString(move[1], eliteChargedMove, false);
                var move3 = getMoveString(move[2], eliteChargedMove, false);
                var moveStr = `${move1}; ${move2}, ${move3}`;
                var moveSum = moveStr;
                if (preMove == moveStr) {
                    moveSum = "(ditto)";
                }
                else {
                }
                strs.push(`<div class='move-header'>${key.split('_')[0]} (${value.rank})</div>: ${moveSum}`);
                preMove = moveStr;

            }
            return strs.join("<br>");
        }

        function getImage(value, type) {
            return "<img class='img_" + type + " img_v_" + value + "' src='./pokemon_go/img/" + type + "_" + value + ".png' alt='" + value + "'/>";
        }

        function getMoveString(move, eliteMoves, isFast) {
            // special cases
            var moveKey = move;
            if (moveKey == "FUTURE_SIGHT") {
                moveKey = "FUTURESIGHT";
            }
            else if (moveKey == "HIDDEN_POWER_FLYING") {
                moveKey = "HIDDEN_POWER_FAST";
            }
            else if (isFast) {
                moveKey = moveKey + "_FAST";
            }
            if (combatMovesDict[moveKey] == undefined) {
                console.log(move, moveKey);
            }
            var type = combatMovesDict[moveKey].type.replace("POKEMON_TYPE_", "").toLowerCase();
            var tags = eliteMoves.includes(move) ? `<span class='move-tag elite-move move-${type}'>Elite</span>` : '';
            var moveName = toTitleCase(move.replace("_", " "));
            return "<div class='move'>" + getImage(type, "type") + `${moveName}${tags}</div>`;
        }

        async function loadAllJsonFiles() {
            try {
                Promise.all([
                    fetch("./pokemon_go/latest/pokemons.json").then(response => response.json()),
                    fetch("./pokemon_go/latest/combatMoves.json").then(response => response.json()),
                    fetch("./pokemon_go/pvp_rankings/rankings-1500-great.json").then(response => response.json()),
                    fetch("./pokemon_go/pvp_rankings/rankings-1500-jungle.json").then(response => response.json()),
                    fetch("./pokemon_go/pvp_rankings/rankings-1500-spring.json").then(response => response.json()),
                    fetch("./pokemon_go/pvp_rankings/rankings-2500-ultra.json").then(response => response.json()),
                    fetch("./pokemon_go/pvp_rankings/rankings-10000-master.json").then(response => response.json())
                ]).then(([e1, m1, r1, r2, r3, r4, r5]) => {
                    pokemons = e1;
                    rankings_great = r1;
                    rankings_jungle = r2;
                    rankings_spring = r3;
                    rankings_ultra = r4;
                    rankings_master = r5;

                    combatMovesDict = {};
                    console.log(m1)
                    var len = m1.length;
                    for (const move of m1) {
                        var settings = move["data"]["combatMove"];
                        var id = settings["uniqueId"];
                        combatMovesDict[id] = settings;
                    }

                    generateTable();
                });
            } catch (error) {
                console.error("Error loading JSON files:", error);
            }
        }

        window.addEventListener('load', function () {
            loadAllJsonFiles();
        })
    </script>
</body>

</html>