<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Go Tools</title>
    <link href="./css/tom-select.bootstrap5.min.css" rel="stylesheet" />
    <link href="./css/bootstrap.min.css" rel="stylesheet" />
    <link href="./css/pokemon_types.css" rel="stylesheet" />
    <style>
        body {
            padding: 10px;
            margin: 0 auto;
            max-width: 1000px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: rgb(224, 224, 224);
        }

        .form-control,
        .full .ts-control {
            background-color: #ededed;
        }

        img {
            height: 20px;
            padding-right: 2px;
        }

        .pokemon-name img {
            height: 30px;
        }

        .stat-div {
            line-height: 1em;
            margin: 10 auto;
            max-width: 500px;
        }

        .stat {
            max-width: 80%;
            margin: 0 auto 16px;
        }

        .cp100 {
            display: inline-block;
            padding: 10px;
            width: 4em;
            text-align: right;
            font-family: monospace;
        }

        div {
            margin: 0;
            padding: 0;
            border: 0;
        }

        .evolved-mon {
            display: inline-block;
            margin-left: 10px;
        }

        .evolved-mon div {
            display: inline-block;
            padding: 0px 3px;
            margin-left: 2px;
        }

        .league1500 {
            background: #4d69d9;
            color: #ff8e82;
        }

        .league2500 {
            background: #515151;
            color: #f5f574;
        }

        .exceeded {
            text-decoration: line-through;
            color: #d7d3d3;
            background: #8f8f8f;
        }

        .glow {
            -webkit-box-shadow: 0px 0px 8px 2px rgb(0 0 0);
            -moz-box-shadow: 0px 0px 8px 2px rgb(0 0 0);
            box-shadow: 0px 0px 8px 2px rgb(0 0 0);
        }

        .iv-group {
            margin: 2px 5px;
            background-color: #eee;
            border: 1px solid #888;
            border-radius: 2px;
            display: inline-block;
            padding: 2px 5px;
            text-align: center;
        }

        .iv4 {
            color: #d93300;
        }

        .iv4 .iv-group {
            background-color: #ffcbbb;
            border-color: #963700;
        }

        .iv3 {
            color: #d97b00;
        }

        .iv3 .iv-group {
            background-color: #ffe2bb;
            border-color: #965000;
        }

        .iv2 {
            color: #209902;
        }

        .iv2 .iv-group {
            background-color: #bdffb0;
            border-color: #005e10;
        }

        .iv1 {
            color: #0050b8;
        }

        .iv1 .iv-group {
            background-color: #b0e2ff;
            border-color: #0a3669;
        }

        .roundSpan {
            text-align: center;
            border-radius: 20px;
            color: white;
            padding: 2px 5px;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
        }

        .inline {
            display: inline-block;
        }

        .inline-input {
            padding: 2px;
            margin: 2px 5px;
        }

        .inline label {
            padding-left: 3px;
        }

        .not-released {
            color: #a0c9ff;
            background-color: #235597;
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
        }

        .flex-container>div {
            width: 150px;
        }
    </style>
    <script type="text/javascript" src="./pokemon_go/pokemon-dps-calcuator.js"></script>
    <script type="text/javascript" src="./js/tom-select.base.min.js"></script>
</head>

<body>
    <h2>Find IV stats from CP</h2>
    <div>
        <div class="mb-3 row align-items-center">
            <label for="pokemon-name" class="col-sm-2 col-form-label">Pokemon:</label>
            <div class="col-sm-10">
                <select id="pokemon-name" onchange="findIVFromCP()"></select>
            </div>
        </div>
        <div class="mb-3 row align-items-center">
            <label for="cpValue" class="col-sm-2 col-form-label">CP:</label>
            <div class="col-sm-10">
                <input id="cpValue" type="number" class="form-control" value="" min="10" max="99999"
                    onkeyup="findIVFromCP()" />
            </div>
            <label for="hpValue" class="col-sm-2 col-form-label mt-3">HP:</label>
            <div class="col-sm-10 mt-3">
                <input id="hpValue" type="number" class="form-control" value="" min="0" max="99999"
                    onkeyup="findIVFromCP()" />
            </div>
            <label for="attackValue" class="col-sm-2 col-form-label mt-3">Attack:</label>
            <div class="col-sm-10 mt-3">
                <input id="attackValue" type="number" class="form-control" value="" min="0" max="15"
                    onkeyup="findIVFromCP()" />
            </div>
        </div>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="findIVFromCP()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearIVFromCP()" />
    <div id="CP-IV-div"></div>

    <hr>

    <h2>Find 100% CP from Pokemon</h2>
    <div>
        <div class="mb-3 row align-items-center">
            <label for="pokemon-name2" class="col-sm-2 col-form-label">Pokemon:</label>
            <div class="col-sm-10">
                <select id="pokemon-name2" onchange="find100CPFromPokemon()"></select>
            </div>
        </div>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="find100CPFromPokemon()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clear100IV()" />
    <div id="CP100_div"></div>

    <hr>

    <h2>Find Pokemon by 100% CP</h2>
    <div>
        <div class="mb-3 row align-items-center">
            <label for="staticEmail" class="col-sm-2 col-form-label">CP:</label>
            <div class="col-sm-10">
                <input id="pok_cpValue" type="number" class="form-control" value="99" min="0" max="100"
                    onkeyup="findPokemonFromCP()" />
            </div>
        </div>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="findPokemonFromCP()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearIVPokeValue()" />
    <div id="cp-pokemon-div" class="flex-container"> </div>

    <script>
        // (deprecated) https://pokemon.gameinfo.io/en/js/pokemon-base.js?v=451d06
        // (deprecated) https://pokemon.gameinfo.io/en/js/pokemon-names.js?v=451d06 from: https://pokemon.gameinfo.io/en/tools/iv-calculator
        // https://pokemon.gameinfo.io/en/js/movesets.js?v=451d06

        // move.json: https://github.com/WHIZENx/PokeGoBreeze/tree/master/src/data/combat.json
        // pokemon.json: https://github.com/WHIZENx/PokeGoBreeze/tree/master/src/data

        function clearIVValue() {
            document.querySelector(".stat-div").innerHTML = "";
        }

        String.prototype.toTitleCase = function () {
            return this.replace(/\w\S*/g, function (txt) { return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase(); });
        };

        var pre_percentage = 0;
        // calculate IV

        var processedPokemon = [];
        var dataPokemons = [];
        var newPokemon = [];

        function PrepareData() {
            for (var i = 0; i < dataPokemons.length; i++) {
                var p = {};
                var d = dataPokemons[i].data;
                if (d.pokemonSettings == undefined) {
                    continue;
                }
                var index = d.templateId.split("_")[0].replace("V", "");
                index = parseInt(index, 10);
                var pSettings = d.pokemonSettings;
                var form = pSettings["form"];
                if (form == undefined) {
                    form = "Normal";
                } else {
                    form = form.replace(pSettings.pokemonId.toUpperCase(), "").replace(/_/g, " ").trim().toTitleCase();
                }
                p.form = form;
                p.index = index;
                p.pokemonId = pSettings.pokemonId;
                p.name = p.form == "Normal" ? p.pokemonId : p.pokemonId + `(${p.form})`
                p.stats = pSettings.stats;
                p.evolutionBranch = pSettings.evolutionBranch;
                p.templateId = dataPokemons[i].templateId;
                newPokemon.push(p);
            }
        }

        function getSpriteName(id, form) {
            form = form.toLowerCase();
            if (form == "normal") {
                return "pm" + id + ".icon.png";
            }

            return "pm" + id + ".f" + form.toUpperCase() + ".icon.png";
        }

        function findPokemonFromCP() {
            var cp = parseInt(document.querySelector("#pok_cpValue").value);
            console.log("findPokemonFromCP:", cp)
            var dict = []
            for (const p of newPokemon) {
                var filtered = {};
                for (var i = 1; i <= MAX_LEVEL; i += 0.5) {
                    var c = calculateCP(p.stats[1] + 15, p.stats[2] + 15, p.stats[0] + 15, i);
                    if (cp == c) {
                        filtered[p.index] = 1;
                        break;
                    }
                    if (c > cp) {
                        break;
                    }
                }
                if (Object.keys(filtered).length > 0) {
                    var iconName = getSpriteName(p.index, p.form);
                    var img = "<img class='pokemon_icon' src='https://raw.githubusercontent.com/PokeMiners/pogo_assets/master/Images/Pokemon/Addressable Assets/" + iconName + "' />";
                    dict.push("<div>" + img + p.name + "</div>");
                }
            }
            document.querySelector("#cp-pokemon-div").innerHTML = dict.join("<br>");
        }

        function calculateIVFromCP(name, code, cp, hp, attack) {
            console.log(code, cp, hp)
            if (null !== code) {
                var st = {};
                for (const p of newPokemon) {
                    if (p.index == code && p.name == name) {
                        st.atk = p.stats[1];
                        st.sta = p.stats[0];
                        st.def = p.stats[2];
                        break;
                    }
                }
                var filtered = {};
                const sta_init = 0;
                const sta_end = 15;
                console.log("stats", st);
                console.log("attach isNaN", isNaN(attack));
                for (var sta_i = sta_init; sta_i <= sta_end; sta_i++) {
                    for (var atk_i = sta_init; atk_i <= sta_end; atk_i++) {
                        if (!isNaN(attack)) {
                            if (atk_i != attack) {
                                continue;
                            }
                        }
                        for (var def_i = sta_init; def_i <= sta_end; def_i++)
                            for (var o = [sta_i, atk_i, def_i], i = 1; i <= MAX_LEVEL; i += 0.5) {
                                var c = calculateCP(st.atk + atk_i, st.def + def_i, st.sta + sta_i, i);
                                var multiplier = data_cp_multiplier.find(item => item.level === i).multiplier;
                                var l = getHp(multiplier, st.sta, sta_i);
                                var hp_match = true;
                                if (hp != null && hp != undefined && hp > 0) {
                                    hp_match = hp == l;
                                }
                                if (c === cp && hp_match) {
                                    var arr = new Int32Array([atk_i, def_i, sta_i, i]);
                                    var key = arr.join(",");
                                    if (!(key in filtered)) {
                                        filtered[key] = arr;
                                    }
                                }
                            }
                    }
                }
                console.log(filtered);
                if (i > MAX_LEVEL && Object.keys(filtered).length == 0) {
                    var stats = [];
                    if (!isNaN(cp)) {
                        stats.push(`CP = ${cp}`);
                    }
                    if (!isNaN(hp)) {
                        stats.push(`HP = ${hp}`);
                    }
                    if (!isNaN(attack)) {
                        stats.push(`Atk = ${attack}`);
                    }
                    return `${name} with ${stats.join(", ")} couldn't be found.`;
                }
                return filtered;
            } else
                return "You must select a Pok√©mon!";
        }

        function getHp(e, t, n) {
            return Math.max(10, Math.floor((t + n) * e))
        }

        function find100CPFromPokemon() {
            var pn = document.querySelector("#pokemon-name2");
            var pnSelected = pn.options[pn.selectedIndex];
            var d_code = pnSelected.getAttribute("data-code");
            var r_div = document.querySelector("#CP100_div");
            var dict = []
            for (const [key, stats] of Object.entries(stats_table)) {
                var p = newPokemon[key];
                if (p == undefined) {
                    continue;
                }
                if (p.name.toLowerCase() != d_code) {
                    continue;
                }
                for (var i = 1; i <= MAX_LEVEL; i += 0.5) {
                    var c = calculateCP(stats.atk + 15, stats.def + 15, stats.sta + 15, i);
                    dict.push("<div class='cp100'>" + c + "</div>");
                }
            }
            r_div.innerHTML = dict.join("");
        }

        function findIVFromCP() {
            var r_div = document.querySelector("#CP-IV-div");
            r_div.innerHTML = "Calculating...";
            var pn = document.querySelector("#pokemon-name");
            var pnSelected = pn.options[pn.selectedIndex];
            var d_code = pnSelected.getAttribute("data-code");
            var d_name = pnSelected.getAttribute("value");
            var cp = document.querySelector("#cpValue").value;
            var hp = document.querySelector("#hpValue").value;
            var attack = document.querySelector("#attackValue").value;
            cp = parseInt(cp);
            hp = parseInt(hp);
            attack = parseInt(attack);
            if (isNaN(cp)) {
                cp = 10;
            }
            console.log("findIVFromCP", cp, hp)
            var result = calculateIVFromCP(d_name, d_code, cp, hp, attack);
            if (typeof result === 'string' || result instanceof String) {
                console.log(result);
                r_div.innerHTML = result;
            }
            else {
                var evoResults = calculateEvolutionsFromCP(d_name, d_code, result);
                var str = ""
                var grouped = {};
                for (const [key, value] of Object.entries(result)) {
                    var sum = [value[0], value[1], value[2]].reduce((x, a) => x + a, 0);
                    var percen = Math.round(sum * 100 / 45);
                    if (!(percen in grouped)) {
                        grouped[percen] = [value]
                    }
                    else {
                        grouped[percen].push(value);
                    }
                }

                var str_a = [];
                for (const [key, value] of Object.entries(grouped)) {
                    var cls = "iv1";
                    if (key >= 66) {
                        cls = "iv2";
                    }
                    if (key >= 80) {
                        cls = "iv3";
                    }
                    if (key == 100) {
                        cls = "iv4";
                    }
                    str = "<div class='row " + cls + " align-items-center'><div class='col-sm-1 col-form-label'>" + key + ":</div>";
                    str += "<div class='col-sm-11'>" + value.map(x => "<div class='iv-group'>" + [x[0], x[1], x[2]].join(", ") + ` (${x[3]})` + getEvolvedCPText(evoResults[x.join(",")]) + "</div>").join("") + "</div>";
                    str += "</div>";
                    str_a.push(str)
                }
                str = "<div class='row align-items-center'><div class='col-sm-1 col-form-label'><strong>IV %</strong></div>"
                    + "<div class='col-sm-11'><strong>IV Stats</strong></div>"
                    + "</div>"
                    + "</div>";
                str_a.push(str);
                str_a.reverse();
                r_div.innerHTML = str_a.join("");
            }
        }

        function getEvolvedCPText(e) {
            var results = [];
            for (const eItem of e) {
                var class1500 = eItem[1500] > 1500 ? "exceeded" : (eItem[1500] >= 1499 ? "glow" : "");
                var class2500 = eItem[2500] > 2500 ? "exceeded" : (eItem[2500] >= 2499 ? "glow" : "");
                var str = `<div class='evolved-mon'>${eItem.pokemon.name}: <div class='league1500 ${class1500}'>${eItem[1500]} (${eItem["1500lvl"]})</div><div class='league2500 ${class2500}'>${eItem[2500]} (${eItem["2500lvl"]})</div></div>`;
                results.push(str);
            }
            return results.join("");
        }

        function isEmpty(obj) {
            return Object.keys(obj).length === 0;
        }


        function calculateEvolutionsFromCP(name, code, ivs) {
            var pokemon = null;
            for (const p of newPokemon) {
                if (p.index == code && p.name == name) {
                    pokemon = p;
                    break;
                }
            }

            if (pokemon == null) {
                return [];
            }

            if (isEmpty(evolutionsList)) {
                LoadEvolutions();
            }

            var allEvolves = [pokemon];

            var preLength = allEvolves.length;
            var newEvolves = getEvolutionListByCode(code);
            allEvolves = allEvolves.concat(newEvolves);
            while (preLength != allEvolves.length) {
                preLength = allEvolves.length;
                var newEvolves2 = [];
                for (const e of newEvolves) {
                    var n = getEvolutionListByCode(e.index);
                    allEvolves = allEvolves.concat(n);
                    newEvolves2 = newEvolves2.concat(n);
                }
                newEvolves = newEvolves2;
            }

            var results = {};
            for (const [key, value] of Object.entries(ivs)) {
                var r = getAllEvolvedCPByIV(value, allEvolves);
                results[key] = r;
            }

            return results;
        }

        function getAllEvolvedCPByIV(iv, allEvolves) {
            var results = []
            for (const a of allEvolves) {
                var maxCPs = {
                    pokemon: a,
                }
                var st = {}
                st.sta = a.stats[0];
                st.atk = a.stats[1];
                st.def = a.stats[2];
                if (iv[0] == 14 && iv[1] == 12 && iv[2] == 15) {
                    console.log(st);
                }
                for (var i = iv[3]; i <= MAX_LEVEL; i += 0.5) {
                    var c = calculateCP(st.atk + iv[0], st.def + iv[1], st.sta + iv[2], i);

                    if (c <= 1500 || !(1500 in maxCPs)) {
                        maxCPs[1500] = c;
                        maxCPs["1500lvl"] = i;
                    }
                    if (c <= 2500 || !(2500 in maxCPs)) {
                        maxCPs[2500] = c;
                        maxCPs["2500lvl"] = i;
                    }
                }
                results.push(maxCPs);
            }

            return results;
        }

        function getEvolutionListByCode(code) {
            var results = []
            if (code in evolutionsList) {
                var e = evolutionsList[code];
                for (const eItem of e) {
                    var r = getEvolvedPokemon(eItem);
                    results.push(r);
                }
            }
            return results;
        }

        String.prototype.indexOfRegex = function (regex) {
            var match = this.match(regex);
            return match ? this.indexOf(match[0]) : -1;
        }

        function getEvolvedPokemon(e) {
            for (const p of newPokemon) {
                if (e.form != undefined && e.form.indexOf(p.form.toUpperCase()) >= 0 && p.templateId.endsWith(e.form)) {
                    return p;
                }

                if (e.form == undefined) {
                    if (p.templateId.endsWith(e.evolution)) {
                        return p;
                    }

                    if (p.templateId.endsWith(e.name)) {
                        return p;
                    }
                }
            }

            if (e.form != undefined) {
                if (e.form.indexOf('_NORMAL') >= 0) {
                    var form = e.form.replace(/_NORMAL/, "");
                    for (const p of newPokemon) {
                        if (p.templateId.endsWith(form)) {
                            return p;
                        }
                    }
                    console.log("cannot find normal form", e);
                }
                else if (e.form.indexOfRegex(/_\d{4}/) >= 0) {
                    var form = e.form.replace(/_\d{4}/, "");
                    for (const p of newPokemon) {
                        if (p.templateId.endsWith(form)) {
                            return p;
                        }
                    }
                    console.log("cannot find numerical form", e);
                }
            }
            console.log("cannot find pokemon", e)
        }

        function clear100IV() {
            var pn = document.querySelector("#CP100_div");
            pn.innerHTML = "";
        }

        function clearIVFromCP() {
            var pn = document.querySelector("#CP-IV-div");
            document.querySelector("#cpValue").value = "";
            document.querySelector("#hpValue").value = "";
            document.querySelector("#attackValue").value = "";
            pn.innerHTML = "";
        }

        function clearIVPokeValue() {
            var pn = document.querySelector("#cp-pokemon-div");
            pn.innerHTML = "";
        }

        function clearCounterList() {
            var pn = document.querySelector("#Counters-div");
            pn.innerHTML = "";
        }

        function clearCounterUniqueList() {
            var pn = document.querySelector("#Counters-Unique-div");
            pn.innerHTML = "";
        }

        function loadPokemonNames() {
            var s = "";
            for (const value of newPokemon) {
                var name = value.name;
                s += "<option value='" + name + "' data-code='" + value.index + "'>" + name + "</option>";
            }
            document.querySelector("#pokemon-name").innerHTML = s;

            new TomSelect("#pokemon-name", {
                create: false,
                sortField: {
                    field: "data-code",
                    direction: "asc"
                }
            });

            document.querySelector("#pokemon-name2").innerHTML = s;

            new TomSelect("#pokemon-name2", {
                create: false,
                sortField: {
                    field: "data-code",
                    direction: "asc"
                }
            });
        }

        var evolutionsList = {};

        function LoadEvolutions() {
            evolutionsList = {};
            // Iterate through the JSON data and create rows for each Pokemon
            for (const pokemon of newPokemon) {
                if (pokemon.evolutionBranch == undefined) {
                    continue;
                }

                var list = [];
                for (var j = 0; j < pokemon.evolutionBranch.length; j++) {
                    var evolution = pokemon.evolutionBranch[j];
                    if (evolution.temporaryEvolution != undefined) {
                        continue;
                    }
                    if (evolution.evolution == undefined) {
                        console.log(evolution);
                        continue;
                    }

                    var p = {};
                    p.name = evolution.evolution;

                    // special cases
                    var form = evolution.form;
                    if (form == "JELLICENT_FEMALE") {
                        form = "JELLICENT_NORMAL"
                    }
                    p.form = form;
                    list.push(p);
                }
                if (pokemon.index in evolutionsList) {
                    evolutionsList[pokemon.index] = list.concat(evolutionsList[pokemon.index])
                }
                else {
                    evolutionsList[pokemon.index] = list;
                }
            }
        }

        // Move sets:
        var data_cp_multiplier = {};
        var evo_list = {};

        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }

        Object.defineProperty(Array.prototype, "find", {
            value: function find(cond) {
                for (var i of this) {
                    if (cond(i)) {
                        return i;
                    }
                }
            },
            writable: true,
            configurable: true,
        });

        Object.defineProperty(Array.prototype, "includes", {
            value: function includes(text) {
                for (var i of this) {
                    if (i == text) {
                        return true;
                    }
                }
                return false;
            },
            writable: true,
            configurable: true,
        });

        Object.defineProperty(Array.prototype, "includesAny", {
            value: function includesAny(arr) {
                for (var i of this) {
                    for (var j of arr) {
                        if (i == j) {
                            return true;
                        }
                    }
                }
                return false;
            },
            writable: true,
            configurable: true,
        });

        const DEFAULT_POKEMON_DEF_OBJ = 160;
        const DEFAULT_POKEMON_SHADOW = false;
        const DEFAULT_TRAINER_FRIEND = false;
        const DEFAULT_WEATHER_BOOSTS = false;
        const DEFAULT_POKEMON_FRIEND_LEVEL = 0;

        const DEFAULT_ENERYGY_PER_HP_LOST = 0.5;
        const DEFAULT_DAMAGE_MULTIPLY = 0.5;
        const DEFAULT_DAMAGE_CONST = 1;

        const MIN_LEVEL = 1;
        const MAX_LEVEL = 45;

        const MIN_IV = 0;
        const MAX_IV = 15;

        async function loadAllJsonFiles() {
            try {
                [dataPokemons] = await Promise.all([
                    fetch("./pokemon_go/latest/pokemons.json").then(response => response.json())
                ]);

                PrepareData();
                loadPokemonNames();
            } catch (error) {
                console.error("Error loading JSON files:", error);
                // Handle errors appropriately, e.g., display error messages to the user
            }
        }

        window.addEventListener('load', function () {
            loadAllJsonFiles();
            fetch("./pokemon_go/cp_multiplier.json")
                .then(response => response.json())
                .then(parsed_data => {
                    data_cp_multiplier = parsed_data;
                });
        })
    </script>
</body>

</html>