<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="initial-scale=1,width=device-width">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Gen VIII Catch Rate Calculator">
    <meta name="twitter:description" content="Gen VIII Catch Rate Calculator">
    <meta property="og:title" content="Gen VIII Catch Rate Calculator">
    <meta property="og:type" content="website">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="304">
    <meta property="og:image:height" content="304">

    <title>Gen VIII Catch Rate Calculator | The Cave of Dragonflies</title>

    <script type="text/javascript" src="./Catch-Rate-Calculator2_files/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="./Catch-Rate-Calculator2_files/promise.polyfill.min.js"></script>
    <script type="text/javascript" src="./Catch-Rate-Calculator2_files/capture-data.js"></script>
    <script src="./js/jsonToTable.js"></script>
    <style type="text/css">
        body {
            margin: 0 auto;
            max-width: 1000px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #ebf4ff;
        }

        th {
            background-color: rgb(22, 98, 141);
            color: white;
        }

        .shakebar, .shakebar span, td span{
            border-collapse: initial;
        }

        #calcform {
            width: 100%;
            position: relative;
        }

        #calcform #hpbar {
            display: inline-block;
            position: relative;
        }

        #calcform #curhp {
            display: block;
            position: absolute;
        }

        #calcform #results p {
            clear: left;
        }

        .calcform-row {
            display: flex;
            flex-wrap: wrap;
        }

        .calcform-row p {
            margin: 0 0.5em 0.8em 0;
        }

        .help-text {
            display: block;
            font-style: italic;
        }

        .shakebar {
            display: table;
            height: 30px;
            border: 1px solid #000;
            padding: 1px 1px 1px 0;
            background: #FFF;
            width: 100%;
            max-width: 400px;
            box-sizing: border-box;
        }

        .shakebar span {
            display: table-cell;
            border-left: 1px solid #FFF;
            min-width: 1px;
        }

        .shakebar .success {
            background: #64ed64;
        }

        .shakebar .wobble3 {
            background: #FFCCCC;
        }

        .shakebar .wobble2 {
            background: #FF9999;
        }

        .shakebar .wobble1 {
            background: #FF6666;
        }

        .shakebar .wobble0 {
            background: #e03a3a;
        }

        .ball-img {
            width: 20px;
            height: 20px;
        }
    </style>

</head>

<body>
    <div id="layout">
        <div id="container">
            <div id="not-affys">
                <div id="content">
                    <h1>Gen VIII Catch Rate Calculator</h1>
                    <form name="calcform" id="calcform">
                        <div class="calcform-row">
                            <p><label>Is this a raid battle? <input type="checkbox" name="raid" id="raid"></label></p>
                        </div>

                        <div class="calcform-row">
                            <p>
                                <label for="pokemon">Pokémon:</label>
                                <select name="pokemon" id="pokemon"></select>
                            </p>

                            <p><label for="level">Pokémon's level:</label>
                                <input type="text" size="3" name="level" id="level" value="20">
                            </p>
                        </div>

                        <div class="calcform-row non-raid-options">
                            <p>Approximation of current HP: <br>
                                <input type="radio" name="hp" value="percent" id="percenthp" checked="checked"> <input type="text" size="3" name="percent" id="percent" value="100"><label for="percenthp">% HP left</label><br>
                                <input type="radio" name="hp" value="1" id="hp1"> <label for="hp1">Exactly 1 HP (using False Swipe or Hold Back)</label>
                            </p>
                        </div>

                        <div class="calcform-row">
                            <p><label for="ball" style="display:none;">Ball:</label><br>
                                <select name="ball" id="ball" style="display:none;">
                                    <option value="show-all" selected="">Show all</option>
                                    <option value="poke-ball">Poké Ball</option>
                                    <option value="great-ball">Great Ball</option>
                                    <option value="ultra-ball">Ultra Ball</option>
                                    <option value="master-ball">Master Ball</option>
                                    <option value="premier-ball">Premier Ball</option>
                                    <option value="net-ball">Net Ball</option>
                                    <option value="nest-ball">Nest Ball</option>
                                    <option value="dive-ball">Dive Ball</option>
                                    <option value="repeat-ball">Repeat Ball</option>
                                    <option value="timer-ball">Timer Ball</option>
                                    <option value="luxury-ball">Luxury Ball</option>
                                    <option value="heal-ball">Heal Ball</option>
                                    <option value="quick-ball">Quick Ball</option>
                                    <option value="dusk-ball">Dusk Ball</option>
                                    <option value="friend-ball">Friend Ball</option>
                                    <option value="fast-ball">Fast Ball</option>
                                    <option value="heavy-ball">Heavy Ball</option>
                                    <option value="level-ball">Level Ball</option>
                                    <option value="love-ball">Love Ball</option>
                                    <option value="lure-ball">Lure Ball</option>
                                    <option value="moon-ball">Moon Ball</option>
                                    <option value="beast-ball">Beast Ball</option>
                                    <option value="dream-ball">Dream Ball</option>
                                </select>
                            </p>

                            <p class="non-raid-options">
                                <label for="status">Status:</label>
                                <select name="status" id="status">
                                    <option value="none">None</option>
                                    <option value="psn">Poisoned</option>
                                    <option value="par">Paralyzed</option>
                                    <option value="brn">Burned</option>
                                    <option value="slp">Asleep</option>
                                    <option value="frz">Frozen</option>
                                </select>
                            </p>
                        </div>

                        <div class="ball-options heavy-ball fast-ball net-ball" style="display: block;">
                            <div class="calcform-row">
                                <p id="pick-form" style="display: none;"><label for="form">Pokémon's form:</label>
                                    <select name="form" id="form">
                                        <option value="0">Clefairy</option>
                                    </select>
                                </p>
                            </div>
                        </div>

                        <div class="ball-options love-ball" style="display: block;">
                            <div class="calcform-row">
                                <p>Gender: <label><input type="radio" name="gender" value="male" checked=""> Male</label> <label><input type="radio" name="gender" value="female"> Female</label> <label><input type="radio" name="gender" value="genderless"> Genderless</label></p>
                            </div>

                            <div class="calcform-row">
                                <p><label for="your-pokemon">Your Pokémon:</label>
                                    <select name="your-pokemon" id="your-pokemon"></select>
                                </p>

                                <p>Your Pokémon's gender:<br>
                                    <label><input type="radio" name="your-gender" value="male" checked=""> Male</label> <label><input type="radio" name="your-gender" value="female"> Female</label> <label><input type="radio" name="your-gender" value="genderless"> Genderless</label>
                                </p>
                            </div>
                        </div>

                        <div class="ball-options timer-ball quick-ball" style="display: block;">
                            <div class="calcform-row">
                                <p><label for="turn">Current turn <small>(in a raid, this is the turn after you win - if you win turn 1, you throw the ball turn 2)</small>:</label><br>
                                    <input type="number" name="turn" id="turn" size="3" value="1" min="1">
                                </p>
                            </div>
                        </div>

                        <div class="ball-options lure-ball" style="display: block;">
                            <div class="calcform-row">
                                <p><label>Are you fishing? <input type="checkbox" name="fishing" id="fishing"></label></p>
                            </div>
                        </div>

                        <div class="ball-options dive-ball" style="display: block;">
                            <div class="calcform-row">
                                <p><label>Are you fighting on or in water? <input type="checkbox" name="underwater" id="underwater"></label></p>
                            </div>
                        </div>

                        <div class="ball-options repeat-ball" style="display: block;">
                            <div class="calcform-row">
                                <p><label>Do you have this Pokémon registered in your Pokédex? <input type="checkbox" name="registered" id="registered"></label></p>
                            </div>
                        </div>

                        <div class="ball-options dusk-ball" style="display: block;">
                            <div class="calcform-row">
                                <p><label>Is it nighttime or are you inside a cave? <input type="checkbox" name="dark" id="dark"></label></p>
                            </div>
                        </div>

                        <div class="raid-options" style="display: none;">
                            <div class="calcform-row">
                                <p><label for="raid-multiplier">Raid difficulty multiplier:</label> <input type="number" name="raid-multiplier" id="raid-multiplier" size="4" step="0.1" min="0.1" max="20.0" value="1.0"></p>
                            </div>
                        </div>

                        <div class="calcform-row">
                            <p><label for="your-level">Your Pokémon's level:</label><br>
                                <input type="text" size="3" name="your-level" id="your-level" value="20">
                            </p>
                        </div>

                        <div class="non-raid-options">
                            <div class="calcform-row">
                                <p><label>Story incomplete? <small>(if you have NOT yet completed the story to the point where the Wild Area Pokémon level up to level 60, check this box)</small> <input type="checkbox" name="incomplete" id="incomplete" value="1"></label></p>
                            </div>

                            <div class="calcform-row">
                                <p><label>Do you have the Catching Charm item? <input type="checkbox" name="catchingcharm" id="catchingcharm" value="1"></label></p>
                            </div>

                            <div class="calcform-row">
                                <p><label for="pokedex">Total Pokémon registered caught in Pokédex <small>(if you have the Expansion Pass, unfortunately this number is not visible in-game; note many Pokémon are in multiple dexes but should only be counted once)</small></label><br>
                                    <input type="text" size="3" name="pokedex" id="pokedex" value="0">
                                </p>
                            </div>

                            <div class="calcform-row">
                                <p><label>In mystery terrain? <small>(still unknown; you probably aren't)</small> <input type="checkbox" name="thickgrass" id="thickgrass" value="1"></label></p>
                            </div>
                        </div>

                        <div class="calcform-row">
                            <p><label><input type="checkbox" name="details" id="details"> Show detailed report?</label>
                                <small class="help-text">If checked, you will see the results for each possible HP IV if they would yield different results; otherwise, you'll see the overall chance assuming you know nothing about the IV. This is only very meaningful at full or exactly 1 HP, since the approximation of the Pokémon's current HP is not exact.</small>
                            </p>
                        </div>

                        <div id="results"></div>
                    </form>

                    <script type="text/javascript">
                        function show_raid_options() {
                            if ($("#raid").prop("checked")) {
                                $(".non-raid-options").hide();
                                $(".raid-options").show();
                            }
                            else {
                                $(".raid-options").hide();
                                $(".non-raid-options").show();
                            }
                        }

                        $("#raid").change(show_raid_options);
                        show_raid_options();

                        init_calculator({
                            auto_calculate: true,
                            default_version_group: 20,
                            max_iv: 31,
                            worker: 'Catch-Rate-Calculator2_files/gen8capture-worker.js',
                            num_wobbles: [
                                "No wobbles",
                                "One wobble",
                                "Two wobbles",
                                "Three wobbles"
                            ],
                            wobble_msg: [
                                "Oh no! The Pokémon broke free!",
                                "Aww! It appeared to be caught!",
                                "Aargh! Almost had it!",
                                "Shoot! It was so close, too!"
                            ],
                            get_extra_params: function () {
                                return {
                                    your_level: $("#your-level").val() * 1 || 1,
                                    turn: $("#turn").val() * 1 || 1,
                                    underwater: $("#underwater").prop("checked"),
                                    registered: $("#registered").prop("checked"),
                                    dark: $("#dark").prop("checked"),
                                    pokedex: $("#pokedex").val() * 1 || 0,
                                    thickgrass: $("#thickgrass").prop("checked"),
                                    postgame: !$("#incomplete").prop("checked"),
                                    catching_charm: $("#catchingcharm").prop("checked"),
                                    gender: $("[name=gender]:checked").val(),
                                    your_gender: $("[name=your-gender]:checked").val(),
                                    your_pokemon: $("#your-pokemon").val() * 1,
                                    fishing: $("#fishing").prop("checked"),
                                    raid: $("#raid").prop("checked"),
                                    raid_multiplier: $("#raid-multiplier").val() * 1
                                };
                            }
                        });

                        var VERSION_GROUPS = {
                            'rb': 1,
                            'y': 2,
                            'gs': 3,
                            'c': 4,
                            'rs': 5,
                            'e': 6,
                            'frlg': 7,
                            'dp': 8,
                            'pt': 9,
                            'hgss': 10,
                            'bw': 11,
                            'b2w2': 14,
                            'xy': 15,
                            'oras': 16,
                            'sm': 17,
                            'usum': 18,
                            'swsh': 20
                        }

                        function init_calculator(settings) {
                            console.log("Init calculator", settings.worker);
                            if (window.Worker && settings.parallelize) {
                                // We can use webworkers; we'll fire them up when we calculate.
                                setup(settings);
                            } else {
                                // We need to load in the worker script normally so that we can create the calculateResults function globally.
                                console.log("About to load worker script");
                                $.getScript(settings.worker, function () {
                                    setup(settings);
                                });
                            }
                        }

                        function getPokemonList() {
                            var s = "";
                            for (var i = 1; i < w.length; i++) {
                                s += "<option value='" + i + "'>" + w[i][0]["name"] + "</option>";
                            }
                            return s;
                        }

                        function setup(settings) {
                            console.log("Doing setup");
                            var $results = $("#results");

                            var cur_results;

                            $("#percenthp, #hp1").click(update_hp);
                            $("#percent").keyup(update_hp);

                            $("#pokemon").html(getPokemonList());
                            $("#your-pokemon").html(getPokemonList());

                            $("#pokemon").change(function () {
                                if ($("#form").length === 0) {
                                    return;
                                }
                                $("#form").empty();
                                var pokemon = $(this).val();
                                for (var i = 0; i < w[pokemon].length; i++) {
                                    if (w[pokemon][i].introduced_in <= settings.default_version_group) {
                                        $("#form").append('<option value="' + i + '">' + w[pokemon][i].name + '</option>');
                                    }
                                }
                                if ($("#form").children().length === 1) {
                                    $("#pick-form").hide();
                                }
                                else {
                                    $("#pick-form").show();
                                }
                            }).change();

                            $("#pokemon").val(1)

                            $("#details").change(function () {
                                if (cur_results) {
                                    display_results(cur_results);
                                }
                            })

                            function show_ball_options() {
                                var ball = $("#ball").val();
                                if (ball === "show-all") {
                                    $(".ball-options").show();
                                } else {
                                    $(".ball-options").hide().filter("." + ball).show();
                                }
                            }
                            $("#ball").change(show_ball_options);
                            show_ball_options();
                            update_hp();

                            if (settings.auto_calculate) {
                                $("#calcform input[type=radio], #calcform input[type=checkbox]:not(#details), #calcform input[type=number], #calcform select").change(calculate);
                                $("#calcform input[type=text], #calcform input[type=number]").keyup(calculate);
                                calculate();
                            } else {
                                $("#calculate").click(function () {
                                    if (settings.custom_calculate) {
                                        settings.custom_calculate(get_calc_params());
                                    } else {
                                        calculate();
                                    }
                                    return false;
                                });
                            }

                            var ball_names = {};

                            $("#ball option").each(function () {
                                if (this.value === 'show-all') return;
                                ball_names[this.value] = this.text;
                            });

                            function calc_cur_hp(max_hp) {
                                var percent = get_hp();
                                if (percent == -1) {
                                    // False Swiped to 1 HP
                                    return 1;
                                }
                                else {
                                    return Math.max(1, Math.round(max_hp * percent / 100));
                                }
                            }

                            function get_hp_bar_class(hp) {
                                if (hp < 20) {
                                    return "low_hp";
                                }
                                else if (hp < 50) {
                                    return "medium_hp";
                                }
                                else {
                                    return "high_hp";
                                }
                            }

                            function update_hp() {
                                var hpfill;
                                var color;
                                var hp = get_hp();
                                if (hp == -1) {
                                    // False Swiped to 1 HP
                                    hpfill = 1;
                                }
                                else {
                                    hpfill = Math.ceil(hp / 100 * 48);
                                }
                                $("#curhp").width(hpfill * 2);
                                $("#curhp").attr("class", get_hp_bar_class(hp));
                            }

                            function get_version_group() {
                                var checked_version = $("input[name=game]:checked").val();
                                if (VERSION_GROUPS.hasOwnProperty(checked_version)) {
                                    return VERSION_GROUPS[checked_version];
                                }
                                return settings.default_version_group;
                            }

                            function get_pokemon(pokemon, form) {
                                // Get Pokémon data, with version-dependent stat modifications.
                                var mon = copy_object(w[pokemon][form || 0]);
                                mon.id = pokemon;
                                mon.form = form;
                                var version_group = get_version_group();

                                // We don't have to undo any stat changes for Sw/Sh; nothing relevant to capture changed.

                                if (version_group < 18) {
                                    // Unapply US/UM stat changes
                                    switch (pokemon) {
                                        case 794: // Buzzwole
                                            mon.catch_rate = 25;
                                            break;
                                        case 795: // Pheromosa
                                            mon.catch_rate = 255;
                                            break;
                                        case 796: // Xurkitree
                                            mon.catch_rate = 30;
                                            break;
                                        case 797: // Celesteela
                                            mon.catch_rate = 25;
                                            break;
                                        case 798: // Kartana
                                            mon.catch_rate = 255;
                                            break;
                                        case 799: // Guzzlord
                                            mon.catch_rate = 15;
                                            break;
                                        case 800: // Necrozma
                                            mon.catch_rate = 3;
                                            break;
                                    }
                                }

                                if (version_group < 17) {
                                    // Unapply Sun/Moon stat changes
                                    switch (pokemon) {
                                        case 85: // Dodrio
                                            mon.speed = 100;
                                            break;
                                        case 101: // Electrode
                                            mon.speed = 140;
                                            break;
                                        case 219: // Magcargo
                                            mon.hp = 50;
                                            break;
                                        case 222: // Corsola
                                            mon.hp = 55;
                                            break;
                                        case 226: // Mantine
                                            mon.hp = 65;
                                            break;
                                        case 284: // Masquerain
                                            mon.speed = 60;
                                            break;
                                        case 301: // Delcatty
                                            mon.speed = 70;
                                            break;
                                        case 337: // Lunatone
                                        case 338: // Solrock
                                            mon.hp = 70;
                                            break;
                                        case 358: // Chimecho
                                            mon.hp = 65;
                                            break;
                                        case 527: // Woobat
                                            mon.hp = 55;
                                            break;
                                    }
                                }

                                if (version_group < 16) {
                                    // Unapply OR/AS catch rate changes
                                    switch (pokemon) {
                                        case 382:
                                        case 383:
                                            // Groudon, Kyogre
                                            mon.catch_rate = 5;
                                            break;
                                        case 483:
                                        case 484:
                                            // Dialga, Palkia
                                            mon.catch_rate = 30;
                                            break;
                                        case 643:
                                        case 644:
                                            // Reshiram, Zekrom
                                            mon.catch_rate = 45;
                                            break;
                                        case 384:
                                            // Rayquaza
                                            mon.catch_rate = 3;
                                            break;
                                    }
                                }

                                if (version_group < 15) {
                                    // Unapply X/Y stat changes
                                    switch (pokemon) {
                                        case 18: // Pidgeot
                                            mon.speed = 91;
                                            break;
                                        case 26: // Raichu
                                            mon.speed = 100;
                                            break;
                                    }
                                }

                                if (version_group < 11 && pokemon === 479) {
                                    // Rotom forms are all Electric/Ghost prior to gen 5.
                                    // We don't have to bother fiddling with the types of every other Pokémon whose types have changed, since the only ones that matter for capture calculations are Bug and Water (because of the Net Ball) and the only other type changes that have happened didn't touch either of those types.
                                    mon.types = ["electric", "ghost"];
                                }

                                if (version_group < 5 && pokemon === 20) {
                                    // Raticate's catch rate changed in R/S/E
                                    mon.catch_rate = 90;
                                }

                                if (version_group === 2) {
                                    // Dragonair and Dragonite's catch rates changed in Yellow
                                    if (pokemon === 148) {
                                        mon.catch_rate = 27;
                                    } else if (pokemon === 149) {
                                        mon.catch_rate = 9;
                                    }
                                }
                                return mon;
                            }

                            function get_hp() {
                                // -1 as a return value from this function stands for False Swiped to 1 HP.
                                if ($("#hp1").is(":checked")) {
                                    // False Swiped to 1 HP
                                    return -1;
                                }
                                else {
                                    // Assume we're looking at a percentage of the max HP
                                    var percent = $("#percent").val();
                                    if (isNaN(percent) || percent > 100) {
                                        return 100;
                                    }
                                    else if (percent <= 0) {
                                        return 1;
                                    }
                                    else {
                                        return percent;
                                    }
                                }
                            }

                            function generate_promise(ball, iv_run, max_hp, calc_params) {
                                return new Promise(function (resolve, reject) {
                                    var params = copy_object(calc_params);
                                    params.ivs = iv_run;
                                    params.max_hp = max_hp;
                                    params.cur_hp = calc_cur_hp(max_hp);
                                    params.ball = ball;

                                    console.log(params);

                                    function return_result(result) {
                                        result.ball = ball;
                                        result.ivs = iv_run;
                                        resolve(result);
                                    }

                                    if (window.Worker && settings.parallelize) {
                                        $results.html('<div class="spinner"></div>');

                                        var w = new Worker(settings.worker);

                                        w.onmessage = function (msg) {
                                            return_result(msg.data);
                                        };

                                        w.postMessage(params);
                                    } else {
                                        return_result(calculateResults(params));
                                    }
                                });
                            }

                            function get_max_hp(pokemon, level, iv) {
                                var basehp = pokemon.hp;
                                // Stat formula for the Pokémon's max HP
                                if (basehp == 1) {
                                    // Shedinja always has 1 HP
                                    return 1;
                                }
                                return Math.floor((2 * basehp + (settings.max_iv === 15 ? 2 * iv : iv)) * level / 100 + level + 10);
                            }

                            function generate_promises(calc_params, ball) {
                                console.log("Generate promises", calc_params, ball);
                                var last_m = null;
                                var promises = [];
                                var iv_run = [];
                                for (var iv = 0; iv <= settings.max_iv; iv++) {
                                    var m = get_max_hp(calc_params.pokemon, calc_params.level, iv);
                                    if (last_m !== null && m !== last_m) {
                                        // We've finished a run of IVs that give identical max HP results! Make a promise for it.
                                        promises.push(generate_promise(ball, iv_run, last_m, calc_params));
                                        iv_run = [];
                                    }
                                    last_m = m;
                                    iv_run.push(iv);
                                }
                                // We've ended our last IV run now - make a last promise for it.
                                promises.push(generate_promise(ball, iv_run, last_m, calc_params));
                                return promises;
                            }

                            function get_calc_params() {
                                var pokemon = $("#pokemon").val() * 1;
                                var form = $("#form").val() * 1 || 0;
                                var mon = get_pokemon(pokemon, form);

                                var ball = $("#ball").val();

                                var status = $("#status").val();

                                var level = $("#level").val() * 1;
                                if (isNaN(level) || Math.floor(level) != level || level < 1 || level > 100) {
                                    alert("Please enter a valid integer between 1 and 100 as the wild Pokémon's level.");
                                    $("#level").val(1);
                                    return false;
                                }

                                var calc_params = {
                                    pokemon: mon,
                                    status: status,
                                    level: level,
                                    version_group: get_version_group(),
                                    ball: ball
                                };

                                if (settings.get_extra_params) {
                                    var extra_params = settings.get_extra_params();
                                    for (var param in extra_params) {
                                        if (extra_params.hasOwnProperty(param)) {
                                            calc_params[param] = extra_params[param];
                                        }
                                    }
                                }

                                if (typeof calc_params.hp_iv != 'undefined') {
                                    var max_hp = get_max_hp(mon, level, calc_params.hp_iv);

                                    calc_params.max_hp = max_hp;
                                    calc_params.cur_hp = calc_cur_hp(max_hp);
                                }

                                return calc_params;
                            }

                            function calculate() {
                                // The Pokémon's level
                                if ($("#level:focus").val() === "") {
                                    // The user is probably in the middle of typing a level - just leave everything alone
                                    return;
                                }

                                var calc_params = get_calc_params();

                                var promises = [];

                                if (calc_params.ball === "show-all") {
                                    $("#ball option").each(function () {
                                        if (this.value === "show-all") return;

                                        promises = promises.concat(generate_promises(calc_params, this.value));
                                    });
                                } else {
                                    promises = generate_promises(calc_params, calc_params.ball);
                                }

                                Promise.all(promises).then(function (results) {
                                    var ball_results = {};

                                    for (var i = 0; i < results.length; i++) {
                                        if (!(results[i].ball in ball_results)) {
                                            ball_results[results[i].ball] = [];
                                        }
                                        ball_results[results[i].ball].push(results[i]);
                                    }

                                    var compact_results = [];

                                    for (var ball in ball_results) {
                                        if (ball_results.hasOwnProperty(ball)) {
                                            (function () {
                                                var distinct_iv_results = [];
                                                for (var i = 0; i < ball_results[ball].length; i++) {
                                                    if (distinct_iv_results.length === 0 || !comp_iv_results(ball_results[ball][i], distinct_iv_results[distinct_iv_results.length - 1])) {
                                                        distinct_iv_results.push(ball_results[ball][i]);
                                                    } else {
                                                        distinct_iv_results[distinct_iv_results.length - 1].ivs = distinct_iv_results[distinct_iv_results.length - 1].ivs.concat(ball_results[ball][i].ivs);
                                                    }
                                                }
                                                for (var i = 0; i < compact_results.length; i++) {
                                                    if (comp_resultset(distinct_iv_results, compact_results[i][0])) {
                                                        compact_results[i].push(distinct_iv_results);
                                                        return;
                                                    }
                                                }
                                                // If we get here, we didn't match with any of the previous results.
                                                compact_results.push([distinct_iv_results]);
                                            })();
                                        }
                                    }

                                    compact_results.sort(function (a, b) {
                                        return avg_successes(b[0]) - avg_successes(a[0]);
                                    });

                                    cur_results = compact_results;

                                    display_results(compact_results);
                                });
                            }

                            function avg_successes(results) {
                                var sum = 0;
                                for (var i = 0; i < results.length; i++) {
                                    sum += results[i].success * results[i].ivs.length;
                                }
                                return sum / settings.max_iv + 1;
                            }

                            function display_results(ball_results) {
                                $results.html("");

                                // Consolidate the ball results and show a bar for each distinct result

                                var r = [];
                                $(ball_results).each(function () {
                                    var b1 = $.map(this, function (results) {
                                        var bn = ball_names[results[0].ball];
                                        return `<img class="ball-img" src="./img/${bn.replace(" ", "_")}.webp" />${bn}`;
                                    }).join('<br>');

                                    var r1 = display_ball_results(this[0]);
                                    var r2 = {
                                        Probability: r1,
                                        Ball: b1
                                    }
                                    r.push(r2);
                                });
                                console.log(r);
                                var generatedTable = buildHtmlTable(r, ["Ball", "Probability"], ["Ball", "Probability"]);
                                $results.append(generatedTable);
                            }

                            function display_ball_results(results) {
                                var details = $("#details").is(":checked");

                                if (details) {
                                    // We want to show a shake bar for each result!
                                    var h = [];
                                    $.each(results, function () {
                                        var $results_heading = $("<h4></h4>");
                                        var iv_string;
                                        if (this.ivs.length === 1) {
                                            iv_string = this.ivs[0].toString();
                                        }
                                        else {
                                            iv_string = this.ivs[0] + "-" + this.ivs[this.ivs.length - 1];
                                        }
                                        $results_heading.text("HP IV of " + iv_string);//.appendTo($results);

                                        h.push($results_heading.html());
                                        h.push(display_result_info(this));
                                    });
                                    return h.join("");
                                } else {
                                    // Consolidate the results into an averaged one.
                                    var averaged_result = {
                                        success: 0,
                                        wobbles: [0, 0, 0, 0],
                                        critical: 0,
                                        crit_success: 0
                                    };
                                    var num_ivs = settings.max_iv + 1;
                                    $.each(results, function () {
                                        averaged_result.success += this.success * this.ivs.length / num_ivs;
                                        for (var i = 0; i < 4; i++) {
                                            averaged_result.wobbles[i] += this.wobbles[i] * this.ivs.length / num_ivs;
                                        }
                                        averaged_result.critical += (this.critical || 0) * this.ivs.length / num_ivs;
                                        averaged_result.crit_success += (this.crit_success || 0) * this.ivs.length / num_ivs;
                                        if (this.glitch) {
                                            averaged_result.glitch = true;
                                            averaged_result.glitch_msg = this.ivs.length === settings.max_iv + 1 ? this.glitch_msg : settings.glitch_msg_average;
                                        }
                                    });

                                    return display_result_info(averaged_result);
                                }
                            }

                            function display_result_info(result) {
                                var rr = $("<div></div>");
                                var extra_message = "";
                                if (result.extra_msg) {
                                    extra_message += " " + result.extra_msg;
                                }
                                if (result.glitch) {
                                    extra_message += " " + result.glitch_msg;
                                }
                                var critical = result.critical || 0;
                                var crit_success = result.crit_success || 0;

                                var $results_p = $("<p></p>");
                                if (result.success === 0 && extra_message) {
                                    $results_p.html(extra_message);
                                }
                                else {
                                    console.log(result);
                                    var $shakebar = $("<div></div>").addClass("shakebar");
                                    if (critical === 0) {
                                        $results_p.html("Chance per ball: <strong>" + show_percent(result.success) + "%</strong>.<br>" + num_balls_message(result.success) + extra_message);
                                    }
                                    else {
                                        var finalchance = critical * crit_success + (1 - critical) * result.success;
                                        $results_p.html("Critical capture = " + show_percent(critical) + "%, which then has a " + show_percent(crit_success) + "% chance of succeeding. Failing that, you have a " + show_percent(result.success) + "% chance of succeeding with a normal capture. All in all, this amounts to a <strong>" + show_percent(finalchance) + "%</strong> chance per ball.<br>" + num_balls_message(finalchance) + extra_message);

                                        $shakebar.append(shake_bar_chunk('success', 'Successful critical capture', '', critical * crit_success));
                                        if (crit_success < 1) {
                                            $shakebar.append(shake_bar_chunk('wobble1', 'Failed critical capture', settings.wobble_msg[0], critical * (1 - crit_success)));
                                        }
                                    }
                                    if (result.success > 0) {
                                        $shakebar.append(shake_bar_chunk('success', 'Successful capture', '', (1 - critical) * result.success));
                                    }
                                    for (var i = 3; i >= 0; i--) {
                                        if (result.wobbles[i] > 0) {
                                            $shakebar.append(shake_bar_chunk('wobble' + i, settings.num_wobbles[i], settings.wobble_msg[i], (1 - critical) * result.wobbles[i]));
                                        }
                                    }

                                    rr.append($shakebar);
                                }
                                rr.append($results_p);
                                return rr.html();
                            }

                            function shake_bar_chunk(span_class, title, message, chance) {
                                var $shake_bar = $("<span></span>").addClass(span_class);
                                var msg = '';
                                if (message != '') {
                                    msg = ' - ' + message;
                                }
                                var percent = show_percent(chance);
                                $shake_bar.attr("title", title + ' (' + percent + '%)' + msg).css('width', percent + '%');
                                return $shake_bar;
                            }
                        }

                        function show_percent(chance) {
                            // Print a nice percentage value for the given chance out of 1.
                            return Math.round(chance * 100000) / 1000;
                        }

                        function copy_object(obj) {
                            var new_obj = {};
                            for (var key in obj) {
                                if (obj.hasOwnProperty(key)) {
                                    new_obj[key] = obj[key];
                                }
                            }
                            return new_obj;
                        }

                        function pluralize(num, word, plural_word) {
                            if (!plural_word) {
                                plural_word = word + "s";
                            }
                            if (num === 1) {
                                return word;
                            }
                            else {
                                return plural_word;
                            }
                        }

                        function num_balls(desired_chance, ball_chance) {
                            // Calculates the number of balls needed to have at least a desired_chance chance of capturing the Pokémon.
                            return Math.ceil(Math.log(1 - desired_chance) / Math.log(1 - ball_chance));
                        }

                        function num_balls_message(ball_chance) {
                            if (ball_chance === 0) {
                                return "Thus, you will never capture it.";
                            }
                            else if (ball_chance === 1) {
                                return "Guaranteed!";
                            }
                            else {
                                var fifty_num_balls = num_balls(0.5, ball_chance);
                                var ninetyfive_num_balls = num_balls(0.95, ball_chance);
                                if (fifty_num_balls == ninetyfive_num_balls) {
                                    return "95% chance of catching it within " + ninetyfive_num_balls + " " + pluralize(ninetyfive_num_balls, "ball") + ".";
                                }
                                else {
                                    return "50% chance of catching it within " + fifty_num_balls + " " + pluralize(fifty_num_balls, "ball") + ".<br>95% chance of catching it within " + ninetyfive_num_balls + " " + pluralize(ninetyfive_num_balls, "ball") + ".";
                                }
                            }
                        }

                        function comp_results(r1, r2) {
                            return comp_iv_results(r1, r2) && r1.ivs.join(',') === r2.ivs.join(',');
                        }

                        function comp_iv_results(r1, r2) {
                            if (r1.success !== r2.success) return false;

                            for (var i = 0; i < 4; i++) {
                                if (r1.wobbles[i] !== r2.wobbles[i]) {
                                    return false;
                                }
                            }
                            return true;
                        }

                        function comp_resultset(r1, r2) {
                            if (r1.length !== r2.length) return false;

                            for (var i = 0; i < r1.length; i++) {
                                if (!comp_results(r1[i], r2[i])) {
                                    return false;
                                }
                            }
                            return true;
                        }

                    </script>

                </div>

            </div>

        </div>

    </div>


</body>

</html>