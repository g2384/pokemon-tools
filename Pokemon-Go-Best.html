<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="utf-8">
    <link href="./css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            margin: 10px;
            padding: 10px;
        }

        .img_type {
            height: 20px;
            padding-right: 2px;
        }

        .form {
            display: inline-block;
            border: 1px solid #888;
            border-radius: 5px;
            padding: 0px 4px;
        }

        .form_mega {
            background-color: #ffe8bf;
        }

        .form_shadow {
            background-color: #dac7f7;
        }

        .form_elite {
            background-color: #c7f7e5;
        }

        .img_icon {
            height: 20px;
            margin-left: 2px;
        }

        .img_v_deploy,
        .img_v_candy,
        .img_v_quest,
        .img_v_legendary,
        .img_v_mythic {
            filter: invert(100%);
        }

        .pokemon_icon {
            height: 40px;
            margin-left: 2px;
        }

        .counter {
            display: inline-block;
        }

        .typedRanking {
            display: inline-block;
            border: 1px solid #888;
            border-radius: 5px;
            padding: 0px 4px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div id="result"></div>
    <script>
        let data = {};
        let counter = {};
        let typedRanking = {};
        let nonLegendaryPokemonCount = {};
        const counterNumber = ["", "★", "❷", "❸", "❹", "❺", "❻", "❼", "❽", "❾", "❿"];
        const typedRankingNumber = ["", "☆", "➁", "➂", "➃", "➄", "➅", "➆", "➇", "➈", "➉", "⑪", "⑫", "⑬", "⑭", "⑮", "⑯", "⑰", "⑱", "⑲",
            "⑳", "㉑", "㉒", "㉓", "㉔", "㉕", "㉖", "㉗", "㉘", "㉙",
            "㉚", "㉛", "㉜", "㉝", "㉞", "㉟", "㊱", "㊲", "㊳", "㊴",
            "㊵", "㊶", "㊷", "㊸", "㊹", "㊺", "㊻", "㊼", "㊽", "㊾", "㊿"];

        function getImage(value, type) {
            return "<img class='img_" + type + " img_v_" + value + "' src='./pokemon_go/img/" + type + "_" + value + ".png' alt='" + value + "'/>";
        }

        function getRemoteImage(value, type) {
            if (type == "item") {
                value1 = value.replace(/\s+/g, "_");
                if (itemLookUp[value1] != undefined) {
                    value1 = itemLookUp[value1];
                }
                if (value == "route_cell") {
                    return "<img src=\"https://raw.githubusercontent.com/PokeMiners/pogo_assets/master/Images/Items/item_route_cell.png\" />";
                }

                return "<img src=\"https://raw.githubusercontent.com/PokeMiners/pogo_assets/master/Images/Items/Bag_" + value1 + "_Sprite.png\" />";
            }
        }

        function printTable() {
            let trs = `<tr><th>Name</th><th>Fast Attack</th><th>Charged Attack</th><th>DPS</th><th>TDO</th><th>t</th><th>PAX</th><th>Score</th><th>Faints</th></tr>`;
            data.results.sort((a, b) => b.score - a.score);

            let tds = [];
            for (let item of data.results) {
                if (counter[item.attacker.name] != undefined) {
                    counter[item.attacker.name]++;
                }
                else {
                    counter[item.attacker.name] = 1;
                }

                var cmType = item.cm.type;
                if (typedRanking[cmType] != undefined) {
                    typedRanking[cmType]++;
                }
                else {
                    typedRanking[cmType] = 1;
                }

                if (typedRanking[cmType] > 50) {
                    continue;
                }

                var nameCell = getPokemonCell(item.attacker, cmType);
                let name = item.attacker["name"];
                if (nameCell.indexOf("mythic") < 0 && nameCell.indexOf("form_shadow") < 0 && nameCell.indexOf("form_mega") < 0 && nameCell.indexOf("form_primal") < 0 && nameCell.indexOf("form_origin") < 0) {
                    if (nonLegendaryPokemonCount[cmType] != undefined) {
                        nonLegendaryPokemonCount[cmType]++;
                    }
                    else {
                        nonLegendaryPokemonCount[cmType] = 1;
                    }

                    if (nonLegendaryPokemonCount[cmType] > 10) {
                        continue;
                    }
                }

                let td = `<tr>`;
                td += `<td>${nameCell}</td>`;
                td += `<td>${getMove(item.qm)}</td>`;
                td += `<td>${getMove(item.cm)}</td>`;
                td += `<td>${item.dps.toFixed(3)}</td>`;
                td += `<td>${item.tdo.toFixed(3)}</td>`;
                td += `<td>${item.t.toFixed(3)}</td>`;
                td += `<td>${item.pax}</td>`;
                td += `<td>${item.score.toFixed(3)}</td>`;
                td += `<td>${item.faints.toFixed(3)}</td>`;
                td += `</tr>`;
                tds.push(td);
            }

            let table = `<table class='table table-striped align-middle' border="1">`
                + trs
                + tds.join("\n")
                + `</table>`;

            document.querySelector("#result").innerHTML = table;
        }

        function getMove(move) {
            let form = "";
            if (move.form != undefined || move.form != null) {
                //form = `<div class='form form_${move.form.toLowerCase().replace(/ /g, "_")}'>` + move.form + "</div>";
            }
            if (move.isLegacy) {
                form += `<div class='form form_elite'>Elite</div>`;
            }
            let html = `${getImage(move.type, "type")} ${move.name} ${form}`;
            return html;
        }

        function getPokemonCell(settings, cmType) {
            name = settings["name"];
            var tradable = settings["isTradable"] == true;
            var deployable = settings["is_deployable"] == true;
            var mythic = settings["isMythical"] == 1;
            var mythicIcon = "";
            if (mythic) {
                mythicIcon = getImage('mythic', "icon");
            }
            var tradableIcon = "";
            if (tradable) {
                tradableIcon = getImage("trade", "icon");
            }
            var deployableIcon = "";
            if (deployable) {
                deployableIcon = getImage("deploy", "icon");
            }
            var form = settings["form"];
            if (form == undefined) {
                form = "Normal";
            }
            var iconName = getSpriteName(settings["id"], form);
            var form = form == "Normal" ? "" : ` <div class='form form_${form.toLowerCase()}'>` + form + "</div>";
            var img = "<img class='pokemon_icon' src='https://raw.githubusercontent.com/PokeMiners/pogo_assets/master/Images/Pokemon/Addressable Assets/" + iconName + "' />";
            nameHtml = "<div class='pokemon_name'>" + img + name + `<div class='counter'>${counterNumber[counter[name]]}</div>` + `<div class='typedRanking'>${getImage(cmType, "type")}${typedRankingNumber[typedRanking[cmType]]}</div>` + form + tradableIcon + deployableIcon + mythicIcon + "</div>";
            return nameHtml;
        }

        function getSpriteName(id, form) {
            form = form.toLowerCase();
            if (form == "shadow") {
                form = "normal";
            }
            form = form.replace(/\s+shadow/g, "");
            if (form == "normal") {
                return "pm" + id + ".icon.png";
            }

            return "pm" + id + ".f" + form.toUpperCase() + ".icon.png";
        }

        async function loadAllJsonFiles() {
            try {
                [data] = await Promise.all([
                    fetch("./pokemon_go/best_per_type.json").then(response => response.json())
                ]);

                printTable();
            } catch (error) {
                console.error("Error loading JSON files:", error);
                // Handle errors appropriately, e.g., display error messages to the user
            }
        }

        window.addEventListener('load',
            function () {
                loadAllJsonFiles();
            });
    </script>
</body>

</html>