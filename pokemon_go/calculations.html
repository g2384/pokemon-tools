<html>

<head>
    <script type="text/javascript" src="./md5.js"></script>
</head>

<body>
    <script>
        var top_counters = {};
        var pokemon_list = {};
        var stats_table = {};
        var top_counters_grouped = {};

        function alwaysBetterThan() {
            var uniqueNames = new Set();
            var namesList = [];
            for (const [gk, gv] of Object.entries(top_counters_grouped)) {
                var nList = [];
                for (const gv_atk of gv.atk) {
                    var pk_name = [gv_atk[1], gv_atk[2], gv_atk[5]].join(",");
                    uniqueNames.add(pk_name);
                    nList.push(pk_name);
                }
                namesList.push(nList);
            }

            var orderedList = [];
            for (const name1 of uniqueNames) {
                for (const name2 of uniqueNames) {
                    var is1AlwaysAbove2 = true;
                    var comparable = false;
                    var alwaysAppearTogether = true;
                    if (name1 != name2) {
                        for (const nList of namesList) {
                            var i1 = nList.indexOf(name1);
                            var i2 = nList.indexOf(name2);
                            if ((i1 < 0 && i2 >= 0) || (i2 < 0 && i1 >= 0)) {
                                alwaysAppearTogether = false;
                            }
                            if (i1 >= 0 && i2 >= 0) {
                                comparable = true;
                                if (i1 > i2) {
                                    is1AlwaysAbove2 = false;
                                    break;
                                }
                            }
                        }
                        if (is1AlwaysAbove2 & comparable & alwaysAppearTogether) {
                            //console.log(name1 + " > " + name2);
                            orderedList.push([name1, name2]);
                        }
                    }
                }
            }
            console.log(orderedList);
            var orderedLongList = [];
            for (const ol of orderedList) {
                var r = getOrderedLongList(orderedList, ol);
                for (const e3 of r) {
                    orderedLongList.push(e3);
                }
            }
            console.log(orderedLongList);
            // verify
            for (const ol of orderedList) {
                var included = false;
                for (const o2 of orderedLongList) {
                    var i1 = o2.indexOf(ol[0]);
                    var i2 = o2.indexOf(ol[1]);
                    if (i1 >= 0 && i2 >= 0) {
                        included = true;
                        if (i1 > i2) {
                            console.log("invalid: " + ol[0] + ", " + ol[1]);
                        }
                    }
                }
                if (!included) {
                    console.log("not included: " + ol[0] + ", " + ol[1]);
                }
            }

            var uniqueLongList = [];
            for (const o of orderedLongList) {
                var isAdded = false;
                for (var i = 0; i < uniqueLongList.length; i++) {
                    var allFound = true;
                    for (const o2 of o) {
                        if (uniqueLongList[i].indexOf(o2) < 0) {
                            allFound = false;
                        }
                    }
                    if (allFound) {
                        isAdded = true;
                        //console.log("included:\n" + uniqueLongList[i].join(",") + "\n" + o.join(","));
                        break;
                    }

                    // swap
                    allFound = true;
                    for (const o2 of uniqueLongList[i]) {
                        if (o.indexOf(o2) < 0) {
                            allFound = false;
                        }
                    }
                    if (allFound) {
                        //console.log("replace:\n" + uniqueLongList[i].join(",") + "\n" + o.join(","));
                        uniqueLongList[i] = o;
                        isAdded = true;
                        break;
                    }
                }
                if (!isAdded) {
                    uniqueLongList.push(o);
                }
            }
            console.log(JSON.stringify(uniqueLongList));
        }

        function getOrderedLongList(orderedList, element) {
            var firstE = element[0];
            var secondE = element[1];
            var result = []
            for (const e2 of orderedList) {
                if (e2[0] == secondE) {
                    var r = getOrderedLongList(orderedList, e2);
                    for (const e3 of r) {
                        result.push([...new Set([firstE, secondE].concat(e3))]);
                    }
                }
            }
            if (result.length == 0) {
                result.push([firstE, secondE]);
            }
            return result;
        }

        function getCounterSetKey(pokemons) {
            var setKey = [];
            var setKeyCopy = new Set();
            var ratios = [];
            for (const moves of pokemons) {
                var k = [moves[0], moves[1], moves[4], moves[7]];
                var ks = k.join(",");
                if (!setKeyCopy.has(ks)) {
                    setKeyCopy.add(ks);
                    setKey.push(moves.slice(0, 8));
                    ratios.push(moves[8]);
                }
            }
            return [setKey, ratios];
        }

        function convertCounterKey(key) {
            var results = [];
            for (const [pk, pv] of Object.entries(pokemon_list)) {
                var def = stats_table[pk];
                var types = pv.types.join(",");
                if (key == types + ":" + def.def) {
                    results.push(pk);
                }
            }
            console.log(results)
            return results;
        }

        // print top_counters_grouped.json
        function printGroupedTopCounters() {
            var dict = {};
            for (const [key, vp] of Object.entries(top_counters)) {
                var [setKey, ratios] = getCounterSetKey(vp);
                //console.log(setKey);
                var setKeyJson = JSON.stringify(setKey);
                var md5Key = md5(setKeyJson);
                if (dict.hasOwnProperty(md5Key)) {
                    dict[md5Key].def.push(key);
                    dict[md5Key].ratios.push(ratios);
                }
                else {
                    dict[md5Key] = {
                        def: [key],
                        atk: setKey,
                        ratios: [ratios]
                    }
                }
            }

            console.log(JSON.stringify(dict));
        }

        // print top_counters_pokemon_lookup.json
        function printNameTypeDictCounters() {
            var dict = {};
            var nameTypeDict = {};
            for (const [key, vp] of Object.entries(top_counters)) {
                var pk_names = convertCounterKey(key);
                nameTypeDict[key] = pk_names;
            }

            console.log(JSON.stringify(nameTypeDict));
        }

        window.addEventListener('load', function () {
            fetch("./pokemon.json")
                .then(response => response.json())
                .then(parsed_data => {
                    pokemon_list = parsed_data;
                });

            fetch("./stats_table.json")
                .then(response => response.json())
                .then(parsed_data => {
                    stats_table = parsed_data;
                });

            fetch("./top_counters.json")
                .then(response => response.json())
                .then(parsed_data => {
                    top_counters = parsed_data;
                });

            fetch("./top_counters_grouped.json")
                .then(response => response.json())
                .then(parsed_data => {
                    top_counters_grouped = parsed_data;
                });
        })
    </script>
</body>

</html>