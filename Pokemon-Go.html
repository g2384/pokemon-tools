<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Go Tools</title>
    <link href="./css/tom-select.bootstrap5.min.css" rel="stylesheet" />
    <link href="./css/bootstrap.min.css" rel="stylesheet" />
    <link href="./css/pokemon_types.css" rel="stylesheet" />
    <style>
        body {
            padding: 10px;
            margin: 0 auto;
            max-width: 1000px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        img {
            height: 20px;
            padding-right: 2px;
        }

        .pokemon-name img {
            height: 30px;
        }

        .stat-div {
            line-height: 1em;
            margin: 10 auto;
            max-width: 500px;
        }

        .stat {
            max-width: 80%;
            margin: 0 auto 16px;
        }

        .iv-div {
            margin-top: 10px;
        }

        .iv-number {
            font-family: Consolas, 'Courier New', Courier, monospace;
            background: rgba(255, 255, 255, 1);
        }

        .stat-bar {
            display: flex;
            background: rgba(0, 0, 0, .08);
            border-radius: 9px;
            margin: 2px 0px;
        }

        .stat-bar .bar:first-child {
            border-left: none;
            border-top-left-radius: 9px;
            border-bottom-left-radius: 9px;
        }

        .stat-bar .bar.active {
            background: #ee9219;
        }

        .stat-bar .bar.end {
            border-top-right-radius: 9px;
            border-bottom-right-radius: 9px;
        }

        .stat-bar .bar {
            height: 18px;
            flex: 1 1 40px;
            border-right: 1px solid rgba(255, 255, 255, .3);
        }

        div {
            margin: 0;
            padding: 0;
            border: 0;
        }

        .stat-bar .bar:nth-child(5n+1) {
            border-left: 4px solid #fff
        }

        .iv-group {
            margin: 2px 5px;
            background-color: #eee;
            border: 1px solid #888;
            border-radius: 2px;
            display: inline-block;
            padding: 2px 5px;
            width: 100px;
            text-align: center;
        }

        .iv3 {
            color: #d97b00;
        }

        .iv3 .iv-group {
            background-color: #ffe2bb;
            border-color: #965000;
        }

        .iv2 {
            color: #209902;
        }

        .iv2 .iv-group {
            background-color: #bdffb0;
            border-color: #005e10;
        }

        .iv1 {
            color: #0050b8;
        }

        .iv1 .iv-group {
            background-color: #b0e2ff;
            border-color: #0a3669;
        }

        .roundSpan {
            text-align: center;
            border-radius: 20px;
            color: white;
            padding: 2px 5px;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
        }

        .inline {
            display: inline-block;
        }

        .inline-input {
            padding: 2px;
            margin: 2px 5px;
        }

        .inline label {
            padding-left: 3px;
        }

        .not-released {
            color: #a0c9ff;
            background-color: #235597;
        }

        .move-tag {
            color: #000;
            font-size: 10px;
            font-weight: 700;
            text-align: center;
            display: inline-block;
            padding: 2px 5px;
            border-radius: 5px;
            margin-left: 3px;
        }

        .elite-move {
            background-color: #f7f70d;
            border: 1px solid #dfc300;
        }

        .shadow-move {
            background-color: #e1caff;
            border: 1px solid #826eed;
        }

        .purified-move {
            background-color: #d3d3d3;
            border: 1px solid #707070;
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
        }

        .flex-container>div {
            width: 150px;
        }
    </style>
    <script type="text/javascript" src="./pokemon_go/imagesConvert.js"></script>
    <script type="text/javascript" src="./pokemon_go/pokemon-types.js"></script>
    <script type="text/javascript" src="./pokemon_go/pokemon-dps-calcuator.js"></script>
    <script type="text/javascript" src="./pokemon_go/md5.js"></script>
    <script type="text/javascript" src="./js/tom-select.base.min.js"></script>
</head>

<body>
    <h2>IV Appraisal Stats Chart</h2>
    <div>
        <div class="mb-3 row align-items-center">
            <label for="staticEmail" class="col-sm-6 col-form-label">List all IV stats above this percentage:</label>
            <div class="col-sm-5">
                <input id="ivValue" type="number" class="form-control" value="90" min="0" max="100"
                    onkeyup="updateIVChart()" />
            </div>
            <div class="col-sm-1">%</div>
        </div>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="updateIVChart()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearIVValue()" />
    <div class="stat-div"> </div>

    <hr>

    <h2>Find IV stats from CP</h2>
    <div>
        <div class="mb-3 row align-items-center">
            <label for="pokemon-name" class="col-sm-2 col-form-label">Pokemon:</label>
            <div class="col-sm-10">
                <select id="pokemon-name" onchange="findIVFromCP()"></select>
            </div>
        </div>
        <div class="mb-3 row align-items-center">
            <label for="cpValue" class="col-sm-2 col-form-label">CP:</label>
            <div class="col-sm-10">
                <input id="cpValue" type="number" class="form-control" value="" min="10" max="99999"
                    onkeyup="findIVFromCP()" />
            </div>
            <label for="hpValue" class="col-sm-2 col-form-label mt-3">HP:</label>
            <div class="col-sm-10 mt-3">
                <input id="hpValue" type="number" class="form-control" value="" min="0" max="99999"
                    onkeyup="findIVFromCP()" />
            </div>
        </div>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="findIVFromCP()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearIVFromCP()" />
    <div id="CP-IV-div"></div>

    <hr>

    <h2>Find Pokemon by 100% CP</h2>
    <div>
        <div class="mb-3 row align-items-center">
            <label for="staticEmail" class="col-sm-2 col-form-label">CP:</label>
            <div class="col-sm-10">
                <input id="pok_cpValue" type="number" class="form-control" value="99" min="0" max="100"
                    onkeyup="findPokemonFromCP()" />
            </div>
        </div>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="findPokemonFromCP()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearIVPokeValue()" />
    <div id="cp-pokemon-div" class="flex-container"> </div>

    <hr>

    <h2>Move List</h2>
    <h5>Pokemon Types</h5>
    <form id="move-pokemon-filters" class="flex-container"> </form>
    <h5>Move Types</h5>
    <form id="move-type-filters" class="flex-container"> </form>
    <form>
        <div class="inline inline-input">
            <input type="checkbox" id="show-top-100" name="show-top-100" checked>
            <label for="show-top-100">Show Top 100</label>
        </div>
    </form>
    <div>
        Exclude these pokemons:
        <textarea id="exclude-pokemons" class="form-control">
        </textarea>
    </div>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="showMoveList()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearMoveList()" />
    <div id="MoveList-div"></div>

    <h2>Counters</h2>
    <input type="button" class="btn btn-outline-primary" value="Show" onclick="showCounterList()" />
    <input type="button" class="btn btn-outline-primary" value="Clear" onclick="clearCounterList()" />
    <div id="Counters-div"></div>

    <script>
        // (deprecated) https://pokemon.gameinfo.io/en/js/pokemon-base.js?v=451d06
        // (deprecated) https://pokemon.gameinfo.io/en/js/pokemon-names.js?v=451d06 from: https://pokemon.gameinfo.io/en/tools/iv-calculator
        // https://pokemon.gameinfo.io/en/js/movesets.js?v=451d06

        // move.json: https://github.com/WHIZENx/PokeGoBreeze/tree/master/src/data/combat.json
        // moves_pokemon_list.json: https://github.com/WHIZENx/PokeGoBreeze/tree/master/src/data/combat_pokemon_go_list.json
        // pokemon.json: https://github.com/WHIZENx/PokeGoBreeze/tree/master/src/data

        const moveOptions = [
            "Non-Legendary", "Released-Only"
        ];

        function convertToCheckBox(value, type, addImage, checked) {
            value2 = type + "-" + value;
            return "<div class='inline inline-input'><input type=\"checkbox\" id=\"move-"
                + value2 + "\" name=\"move-"
                + value2 + "\"" + (checked == true ? "checked" : "")
                + "><label for=\"move-"
                + value2 + "\">"
                + (addImage ? "<img src='./pokemon_go/type_" + value.toLowerCase() + ".png' />" : "")
                + value + "</label></div>";
        }

        function generateMoveOptions() {
            var str = "";
            for (var value of pokemon_types) {
                str += convertToCheckBox(value, "pokemon", true)
            }
            for (var value of moveOptions) {
                str += convertToCheckBox(value, "pokemon", false, true)
            }
            document.querySelector("#move-pokemon-filters").innerHTML = str;

            var str = "";
            for (var value of pokemon_types) {
                str += convertToCheckBox(value, "type", true)
            }
            document.querySelector("#move-type-filters").innerHTML = str;
        }

        function clearIVValue() {
            document.querySelector(".stat-div").innerHTML = "";
        }

        var pre_percentage = 0;
        function updateIVChart() {
            var percentage = document.querySelector("#ivValue").value;
            var percentage = parseInt(percentage);
            if (percentage == pre_percentage) {
                return;
            }
            pre_percentage = percentage;
            var filtered = {};
            for (var i = 1; i <= 15; i++) {
                for (var j = 1; j <= 15; j++) {
                    for (var k = 1; k <= 15; k++) {
                        if (Math.round((i + j + k) / 45 * 100) >= percentage) {
                            var newA = new Int32Array([i, j, k]);
                            newA.sort();
                            var key = newA.join(",");
                            if (!(key in filtered)) {
                                filtered[key] = newA;
                            }
                        }
                    }
                }
            }
            console.log(filtered);

            var result = "";
            for (const [key, value] of Object.entries(filtered)) {
                var str = "<div class='iv-div'>";
                var sum = value.reduce((partialSum, a) => partialSum + a, 0);
                str += "<h4>" + Math.round(sum * 100 / 45) + "</h4>";
                for (i of value) {
                    str += "<div class='stat-bar'>";
                    for (var j = 1; j < i; j++) {
                        str += "<div class='bar active hover'></div>";
                    }
                    str += "<div class='bar active hover end'></div>";
                    for (var j = i; j < 15; j++) {
                        str += "<div class='bar'></div>";
                    }
                    str += "<div class='iv-number'>" + (i < 10 ? ("0" + i) : i) + "</div>";
                    str += "</div>"
                }
                str += "</div>"
                result += str;
            }

            var div = document.querySelector(".stat-div");
            div.innerHTML = result;
        }

        // calculate IV

        var processedPokemon = []

        // print stats_table.json
        function printPokemonBaseStat() {
            var dict = {};
            for (const [key, vp] of Object.entries(newPokemon)) {
                let stats = calculateStatsByTag(vp.baseStats, vp.forme)
                dict[key] = stats;
            }
            console.log(JSON.stringify(dict));
        }

        function findPokemonFromCP() {
            var cp = parseInt(document.querySelector("#pok_cpValue").value);
            console.log(cp)
            var dict = []
            for (const [key, stats] of Object.entries(stats_table)) {
                var p = newPokemon[key];
                var filtered = {};
                for (var i = 1; i <= 40; i += 0.5) {
                    var c = calculateCP(stats.atk + 15, stats.def + 15, stats.sta + 15, i);
                    if (cp == c) {
                        filtered[key] = 1;
                        break;
                    }
                    if (c > cp) {
                        break;
                    }
                }
                if (Object.keys(filtered).length > 0) {
                    dict.push("<div>" + getImageElement(p.num, key) + p.name + "</div>");
                }
            }
            document.querySelector("#cp-pokemon-div").innerHTML = dict.join("<br>");
        }

        function calculateIVFromCP(code, cp, hp) {
            console.log(code, cp, hp)
            if (null !== code) {
                var e = code.split(",");
                var t = e[0], n = e[1], st = stats_table[code];
                var r = [st.sta, st.atk, st.def];
                var filtered = {};
                var sta_init = 0;
                var sta_end = 15;
                for (var sta_i = 0; sta_i <= 15; sta_i++)
                    for (var atk_i = 0; atk_i <= 15; atk_i++)
                        for (var def_i = 0; def_i <= 15; def_i++)
                            for (var o = [sta_i, atk_i, def_i], i = 1; i <= 40; i += 0.5) {
                                var c = calculateCP(st.atk + atk_i, st.def + def_i, st.sta + sta_i, i);
                                var multiplier = data_cp_multiplier.find(item => item.level === i).multiplier;
                                var l = getHp(multiplier, r, o);
                                var hp_match = true;
                                if (hp != null && hp != undefined && hp > 0) {
                                    hp_match = hp == l;
                                }
                                if (c === cp && hp_match) {
                                    var arr = new Int32Array([sta_i, atk_i, def_i]);
                                    arr.sort();
                                    var key = arr.join(",");
                                    if (!(key in filtered)) {
                                        filtered[key] = arr;
                                    }
                                }
                            }
                console.log(filtered);
                if (i > 40 && Object.keys(filtered).length == 0) {
                    return "A Pokemon with those stats couldn't be found.";
                }
                return filtered;
            } else
                return "You must select a Pokémon!";
        }

        function getHp(e, t, n) {
            return Math.max(10, Math.floor((t[0] + n[0]) * e))
        }

        function findIVFromCP() {
            var pn = document.querySelector("#pokemon-name");
            var d_code = pn.options[pn.selectedIndex].getAttribute("data-code");
            var cp = document.querySelector("#cpValue").value;
            var hp = document.querySelector("#hpValue").value;
            cp = parseInt(cp);
            hp = parseInt(hp);
            var result = calculateIVFromCP(d_code, cp, hp);
            var r_div = document.querySelector("#CP-IV-div");
            if (typeof result === 'string' || result instanceof String) {
                console.log(result);
                r_div.innerHTML = result;
            }
            else {
                var str = ""
                var grouped = {};
                for (const [key, value] of Object.entries(result)) {
                    var sum = value.reduce((x, a) => x + a, 0);
                    var percen = Math.round(sum * 100 / 45);
                    if (!(percen in grouped)) {
                        grouped[percen] = [value]
                    }
                    else {
                        grouped[percen].push(value);
                    }
                }

                var str_a = [];
                for (const [key, value] of Object.entries(grouped)) {
                    var cls = "iv1";
                    if (key >= 66) {
                        cls = "iv2";
                    }
                    if (key >= 80) {
                        cls = "iv3";
                    }
                    str = "<div class='row " + cls + " align-items-center'><div class='col-sm-1 col-form-label'>" + key + ":</div>";
                    str += "<div class='col-sm-11'>" + value.map(x => "<div class='iv-group'>" + x.join(", ") + "</div>").join("") + "</div>";
                    str += "</div>";
                    str_a.push(str)
                }
                str = "<div class='row align-items-center'><div class='col-sm-1 col-form-label'><strong>IV %</strong></div>"
                    + "<div class='col-sm-11'><strong>IV Stats</strong></div>"
                    + "</div>"
                    + "</div>";
                str_a.push(str);
                str_a.reverse();
                r_div.innerHTML = str_a.join("");
            }
        }

        function clearIVFromCP() {
            var pn = document.querySelector("#CP-IV-div");
            pn.innerHTML = "";
        }

        function clearIVPokeValue() {
            var pn = document.querySelector("#cp-pokemon-div");
            pn.innerHTML = "";
        }

        function clearCounterList() {
            var pn = document.querySelector("#Counters-div");
            pn.innerHTML = "";
        }

        function loadPokemonNames() {
            var s = "";
            for (const value of processedPokemon) {
                var name = value.label;
                s += "<option value='" + name + "' data-code='" + value.code + "'>" + name + "</option>";
            }
            document.querySelector("#pokemon-name").innerHTML = s;

            new TomSelect("#pokemon-name", {
                create: false,
                sortField: {
                    field: "text",
                    direction: "asc"
                }
            });
        }

        function convertToCounterTable(line) {
            var s = "<table>{trs}</table>";
            var trs = [];
            for (const l of line) {
                var tr = "<tr>";
                var quickMoveTag = convertMoveTagToHtml(l[4]);
                var chargeMoveTag = convertMoveTagToHtml(l[7]);
                var p = newPokemon[l[1]];
                var releasedTag = p.releasedGO ? "" : "<span class='not-released roundSpan'>N/A</span>"
                tr += "<td>" + l[0] + "</td>" + "<td>" + getImageElement(p.num, p.name) + p.name + releasedTag + "</td>"
                    + "<td><img src='./pokemon_go/type_" + l[3].toLowerCase() + ".png' />" + l[2] + quickMoveTag + "</td>"
                    + "<td><img src='./pokemon_go/type_" + l[6].toLowerCase() + ".png' />" + l[5] + chargeMoveTag + "</td>";
                tr += "</tr>";
                trs.push(tr);
            }
            s = s.replace("{trs}", trs.join(""))
            return s;
        }

        function showCounterList() {
            var html = "";
            for (const [key, value] of Object.entries(top_counters_grouped)) {
                var p_names = [];
                for (const def of value.def) {
                    var p_name = top_counters_pokemon_lookup[def];
                    p_names = p_names.concat(p_name);
                }
                html += "<div><div class='inline m-2'>" + p_names.join("</div><div class='inline m-2'>") + "</div></div>";
                html += "<div>" + convertToCounterTable(value.atk) + "</div>";
            }
            document.querySelector("#Counters-div").innerHTML = html;
        }

        // Move sets:
        var allMoveSet = [];
        var newAllMoves = {};
        var moves_Pokemon_List = {};
        var newPokemon = {};
        var data_cp_multiplier = {};
        var dps_table = {};
        var pokemon_go_options = {};
        var stats_table = {};
        var type_effectiveness = {};
        var top_counters_grouped = {};
        var top_counters_pokemon_lookup = {};

        function toTitleCase(str) {
            return str.replace(
                /\w\S*/g,
                function (txt) {
                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }

        function findMove(str) {
            for (var m1 of newAllMoves) {
                if (m1["name"] == str || m1["name"] + "_" + m1["type_move"] == str) {
                    return m1;
                    break;
                }
            }
        }

        function calculateStatsBattle(base, iv, level, floor, addition) {
            let result = (base + iv) * data_cp_multiplier.find(item => item.level === level).multiplier;
            if (addition) result *= addition;
            if (floor) return Math.floor(result);
            return result
        }

        Object.defineProperty(Array.prototype, "find", {
            value: function find(cond) {
                for (var i of this) {
                    if (cond(i)) {
                        return i;
                    }
                }
            },
            writable: true,
            configurable: true,
        });

        Object.defineProperty(Array.prototype, "includes", {
            value: function includes(text) {
                for (var i of this) {
                    if (i == text) {
                        return true;
                    }
                }
                return false;
            },
            writable: true,
            configurable: true,
        });

        Object.defineProperty(Array.prototype, "includesAny", {
            value: function includesAny(arr) {
                for (var i of this) {
                    for (var j of arr) {
                        if (i == j) {
                            return true;
                        }
                    }
                }
                return false;
            },
            writable: true,
            configurable: true,
        });

        const DEFAULT_POKEMON_DEF_OBJ = 160;
        const DEFAULT_POKEMON_SHADOW = false;
        const DEFAULT_TRAINER_FRIEND = false;
        const DEFAULT_WEATHER_BOOSTS = false;
        const DEFAULT_POKEMON_FRIEND_LEVEL = 0;

        const DEFAULT_ENERYGY_PER_HP_LOST = 0.5;
        const DEFAULT_DAMAGE_MULTIPLY = 0.5;
        const DEFAULT_DAMAGE_CONST = 1;

        const MIN_LEVEL = 1;
        const MAX_LEVEL = 51;

        const MIN_IV = 0;
        const MAX_IV = 15;

        const options = {
            delay: null,
            specific: null,
            WEATHER_BOOSTS: false,
            TRAINER_FRIEND: false,
            TRAINER_FRIEND_LEVEL: 0,
            POKEMON_DEF_OBJ: DEFAULT_POKEMON_DEF_OBJ,
        };

        const filters = {
            showEliteMove: true,
            showShadow: true,
            showMega: true,
            enableShadow: false,
            enableElite: false,
            enableMega: false,
            enableBest: false,
            enableDelay: false,
            releasedGO: true,
            bestOf: 3,
            IV_ATK: 15,
            IV_DEF: 15,
            IV_HP: 15,
            POKEMON_LEVEL: 40
        };

        function convertMoveToText(t) {
            return toTitleCase(t.replace("_FAST", "").replace(/_/g, " "));
        }

        // generate dps_table.json
        function convertToDpsTable() {
            var processed = {};
            allMoveSet = {};
            for (var value of moves_Pokemon_List) {
                var quickMoves = value["QUICK_MOVES"].concat(value["ELITE_QUICK_MOVES"]);
                var chargeMoves = value["CINEMATIC_MOVES"].concat(value["SHADOW_MOVES"], value["PURIFIED_MOVES"], value["ELITE_CINEMATIC_MOVES"])
                var allMoves = [];
                var pokm = "";
                var pokm_key = "";
                var newName = value["NAME"].replace(/_/g, "").replace("FEMALE", "F").replace("MALE", "M");
                for (const [key, vp] of Object.entries(newPokemon)) {
                    if (key.toUpperCase() == newName) {
                        pokm = vp;
                        pokm_key = key;
                    }
                }
                if (pokm == "") {
                    console.log("can't find: " + value["NAME"] + ", " + newName);
                }
                for (var v1 of quickMoves) {
                    if (value["ELITE_QUICK_MOVES"].indexOf(v1) >= 0) {
                        quickMoveType = "Elite";
                    }
                    else {
                        quickMoveType = "Normal";
                    }
                    for (var v2 of chargeMoves) {
                        if (value["SHADOW_MOVES"].indexOf(v2) >= 0) {
                            chargeMoveType = "Shadow";
                        }
                        else if (value["PURIFIED_MOVES"].indexOf(v2) >= 0) {
                            chargeMoveType = "Purified";
                        }
                        else if (value["ELITE_CINEMATIC_MOVES"].indexOf(v2) >= 0) {
                            chargeMoveType = "Elite";
                        }
                        else {
                            chargeMoveType = "Normal";
                        }
                        var m1 = findMove(v1);
                        var m2 = findMove(v2);

                        var types = [];

                        let stats = calculateStatsByTag(pokm.baseStats, pokm.forme);
                        var atk_2 = calculateStatsBattle(stats.atk, filters.IV_ATK, filters.POKEMON_LEVEL);
                        var def_2 = calculateStatsBattle(stats.def, filters.IV_DEF, filters.POKEMON_LEVEL);
                        var sta_2 = calculateStatsBattle(stats.sta, filters.IV_HP, filters.POKEMON_LEVEL);
                        var dps = calculateAvgDPS(m1, m2, atk_2, def_2, sta_2, pokm.types, options, false);
                        var tdo = calculateTDO(def_2, sta_2, dps, false)
                        allMoves.push([convertMoveToText(v1),
                        m1.type.toLowerCase(),
                        convertMoveToText(v2).replace("Super Power", "Superpower"),
                        m2.type.toLowerCase(),
                            dps,
                            tdo,
                        dps ** 3 * tdo,
                            quickMoveType,
                            chargeMoveType])
                    }
                }
                var p = {
                    "all_moves": allMoves,
                    "id": value["ID"],
                    "name": pokm.name
                }
                allMoveSet[pokm_key] = p;
            }
            console.log(JSON.stringify(allMoveSet), null, 4);
        }

        function numberWithCommas(x, round) {
            var parts = (Math.round(x * 10 ** round) / 10 ** round).toString().split(".");
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return parts.join(".");
        }

        function showMoveList() {
            var enabledOptions = []
            for (var value of moveOptions) {
                var id = "#move-" + "pokemon-" + value;
                var opt = document.querySelector(id).checked;
                if (opt) {
                    enabledOptions.push(value);
                }
            }
            var filterTypes = false;
            for (var value of pokemon_types) {
                var id = "#move-" + "pokemon-" + value;
                var opt = document.querySelector(id).checked;
                if (opt) {
                    filterTypes = true;
                    enabledOptions.push(value);
                }
            }
            var excludeLegendary = enabledOptions.includes("Non-Legendary");
            var includeReleasedOnly = enabledOptions.includes("Released-Only");
            var capitalOptions = enabledOptions.map(x => toTitleCase(x));
            var excludepokemons = document.querySelector("#exclude-pokemons").innerHTML.toLowerCase();
            var showTop100 = document.querySelector("#show-top-100").checked;

            var enabledMoveTypes = []
            for (var value of pokemon_types) {
                var id = "#move-" + "type-" + value;
                var opt = document.querySelector(id).checked;
                if (opt) {
                    enabledMoveTypes.push(value.toLowerCase());
                }
            }
            var filterMoveTypes = enabledMoveTypes.length > 0;
            console.log(excludeLegendary, includeReleasedOnly, filterTypes, filterMoveTypes, enabledOptions, enabledMoveTypes)

            var allMovesArray = SortDps(dps_table, newPokemon, excludeLegendary, includeReleasedOnly, filterTypes, capitalOptions, filterMoveTypes, enabledMoveTypes, excludepokemons);

            allMovesArray = allMovesArray.sort(function (e, t) {
                return t[8] - e[8] // DPS^3*TDO
            });

            var showTop = showTop100 ? 100 : -1;
            var str = GenerateDpsAttackTable(allMovesArray, showTop, dps_table, newPokemon, pokemonGo_Assets_ImagesConvert);
            document.querySelector("#MoveList-div").innerHTML = str;

            return;
        }

        function clearMoveList() {
            document.querySelector("#MoveList-div").innerHTML = "";
        }

        function getBarCharge(isRaid, energy) {
            energy = Math.abs(energy);
            if (isRaid) {
                const bar = Math.ceil(100 / energy)
                return bar > 3 ? 3 : bar;
            } else return energy > 50 ? 1 : 2;
        }

        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function getMultiFriendshipMulti(level) {
            return pokemon_go_options["data"]["trainer_friendship"][level.toString()]["atk_bonus"];
        }

        function getTypeEffective(typeMove, typesObj) {
            let value_effective = 1;
            typesObj.forEach(type => {
                try { value_effective *= type_effectiveness[capitalize(typeMove.toLowerCase())][capitalize(type.type.name.toLowerCase())]; }
                catch { value_effective *= type_effectiveness[capitalize(typeMove.toLowerCase())][capitalize(type.toLowerCase())]; }
            });
            return value_effective;
        }

        function calculateAvgDPS(fmove, cmove, Atk, Def, HP, typePoke, options, shadow) {
            const FPow = fmove.pve_power;
            const CPow = cmove.pve_power;
            const FE = Math.abs(fmove.pve_energy);
            const CE = Math.abs(cmove.pve_energy);
            const FDur = fmove.durationMs / 1000;
            const CDur = cmove.durationMs / 1000;
            const FTYPE = capitalize(fmove.type.toLowerCase());
            const CTYPE = capitalize(cmove.type.toLowerCase());
            const CDWS = cmove.damageWindowStartMs / 1000;
            var STAB_MULTIPLY = pokemon_go_options["data"]["battle_options"]["stab"];
            var SHADOW_DEF_BONUS = pokemon_go_options["data"]["combat_options"]["shadow_bonus"]["def"];
            var SHADOW_ATK_BONUS = pokemon_go_options["data"]["combat_options"]["shadow_bonus"]["atk"];

            const FMulti = (typePoke.includes(FTYPE) ? STAB_MULTIPLY : 1) * fmove.accuracyChance;
            const CMulti = (typePoke.includes(CTYPE) ? STAB_MULTIPLY : 1) * cmove.accuracyChance;

            let y, FDmg, CDmg, FDmgBase, CDmgBase;
            if (options) {
                FDmgBase = DEFAULT_DAMAGE_MULTIPLY * FPow * FMulti * (shadow ? SHADOW_ATK_BONUS : 1) * (typeof options.WEATHER_BOOSTS === "string" ? weatherMultiple(options.WEATHER_BOOSTS, FTYPE) : options.WEATHER_BOOSTS ? STAB_MULTIPLY : 1) * (options.TRAINER_FRIEND ? getMultiFriendshipMulti(options.TRAINER_FRIEND_LEVEL) : 1);
                CDmgBase = DEFAULT_DAMAGE_MULTIPLY * CPow * CMulti * (shadow ? SHADOW_ATK_BONUS : 1) * (typeof options.WEATHER_BOOSTS === "string" ? weatherMultiple(options.WEATHER_BOOSTS, CTYPE) : options.WEATHER_BOOSTS ? STAB_MULTIPLY : 1) * (options.TRAINER_FRIEND ? getMultiFriendshipMulti(options.TRAINER_FRIEND_LEVEL) : 1);

                FDmg = Math.floor(FDmgBase * Atk * (options.objTypes ? getTypeEffective(FTYPE, options.objTypes) : 1) / options.POKEMON_DEF_OBJ) + DEFAULT_DAMAGE_CONST;
                CDmg = Math.floor(CDmgBase * Atk * (options.objTypes ? getTypeEffective(CTYPE, options.objTypes) : 1) / options.POKEMON_DEF_OBJ) + DEFAULT_DAMAGE_CONST;

                y = 900 / ((Def / (options.objTypes ? getTypeEffective(FTYPE, options.objTypes) * getTypeEffective(CTYPE, options.objTypes) : 1)) * (shadow ? SHADOW_DEF_BONUS : 1));
            } else {
                FDmgBase = DEFAULT_DAMAGE_MULTIPLY * FPow * FMulti * (DEFAULT_POKEMON_SHADOW ? SHADOW_ATK_BONUS : 1) * (DEFAULT_WEATHER_BOOSTS ? STAB_MULTIPLY : 1) * (DEFAULT_TRAINER_FRIEND ? getMultiFriendshipMulti(DEFAULT_POKEMON_FRIEND_LEVEL) : 1);
                CDmgBase = DEFAULT_DAMAGE_MULTIPLY * CPow * CMulti * (DEFAULT_POKEMON_SHADOW ? SHADOW_ATK_BONUS : 1) * (DEFAULT_WEATHER_BOOSTS ? STAB_MULTIPLY : 1) * (DEFAULT_TRAINER_FRIEND ? getMultiFriendshipMulti(DEFAULT_POKEMON_FRIEND_LEVEL) : 1);

                FDmg = Math.floor(FDmgBase * Atk / DEFAULT_POKEMON_DEF_OBJ) + DEFAULT_DAMAGE_CONST;
                CDmg = Math.floor(CDmgBase * Atk / DEFAULT_POKEMON_DEF_OBJ) + DEFAULT_DAMAGE_CONST;

                y = 900 / (Def * (DEFAULT_POKEMON_SHADOW ? SHADOW_DEF_BONUS : 1));
            }

            const FDPS = FDmg / (FDur + (options && options.delay ? options.delay.ftime : 0));
            const CDPS = CDmg / (CDur + (options && options.delay ? options.delay.ctime : 0));

            const CEPSM = CE === 100 ? 0.5 * FE + 0.5 * y * CDWS : 0;
            const FEPS = FE / (FDur + (options && options.delay ? options.delay.ftime : 0));
            const CEPS = (CE + CEPSM) / (CDur + (options && options.delay ? options.delay.ctime : 0));

            let x = 0.5 * CE + 0.5 * FE;
            if (options && options.specific) {
                const bar = getBarCharge(true, CE);
                let λ;
                if (bar === 1) λ = 3;
                else if (bar === 2) λ = 1.5;
                else if (bar === 3) λ = 1;
                x += 0.5 * λ * options.specific.FDmgenemy + options.specific.CDmgenemy * λ + 1;
            }

            const DPS0 = (FDPS * CEPS + CDPS * FEPS) / (CEPS + FEPS);

            let DPS;
            if (FDPS > CDPS) DPS = DPS0;
            else DPS = Math.max(0, DPS0 + ((CDPS - FDPS) / (CEPS + FEPS) * (DEFAULT_ENERYGY_PER_HP_LOST - (x / HP)) * y));
            return Math.max(FDPS, DPS);
        }

        function calculateTDO(Def, HP, dps, shadow) {
            let y;
            var SHADOW_DEF_BONUS = pokemon_go_options["data"]["combat_options"]["shadow_bonus"]["def"];
            if (shadow) y = 900 / (Def * (shadow ? SHADOW_DEF_BONUS : 1));
            else y = 900 / (Def * (DEFAULT_POKEMON_SHADOW ? SHADOW_DEF_BONUS : 1));
            return HP / y * dps;
        }

        function convertName(text) {
            return text.toUpperCase()
                .replace(/\-/g, "_")
                .replace("NIDORAN_F", "NIDORAN_FEMALE")
                .replace("NIDORAN_M", "NIDORAN_MALE")
                .replace(/\u2019/g, "")
                .replace(/\u0301/g, "")
                .replace(/\./g, "")
                .replace(/\:/g, "")
                .replace(/ /g, "_")
                .replace("É", "E")
                .replace("PUMPKABOO_AVERAGE", "PUMPKABOO")
                .replace("GOURGEIST_AVERAGE", "GOURGEIST")
        };

        const queryMoveCounter = (dataList, pokemon, stats, def, types, vf, cmove, ftag, ctag) => {
            cmove.forEach(vc => {
                let mf = newAllMoves.find(item => item.name === vf.replace("_FAST", ""));
                let mc = newAllMoves.find(item => item.name === vc);

                let def_max = calculateStatsBattle(def, 15, 40, true);
                let options = {
                    objTypes: types,
                    POKEMON_DEF_OBJ: def_max,
                    IV_ATK: 15,
                    IV_DEF: 15,
                    IV_HP: 15,
                    POKEMON_LEVEL: 40
                }

                let atk2 = calculateStatsBattle(stats.atk, options.IV_ATK, options.POKEMON_LEVEL, true);
                let def2 = calculateStatsBattle(stats.def, options.IV_DEF, options.POKEMON_LEVEL, true);
                let sta2 = calculateStatsBattle(stats.sta, options.IV_HP, options.POKEMON_LEVEL, true);
                let dpsOff = calculateAvgDPS(mf, mc, atk2, def2, sta2, pokemon.types, options);

                dataList.push({
                    pokemon_id: pokemon.num,
                    pokemon_key: pokemon.alias,
                    pokemon_name: pokemon.name,
                    pokemon_forme: pokemon.forme,
                    releasedGO: pokemon.releasedGO,
                    dps: dpsOff,
                    fmove: { type: capitalize(mf.type), name: capitalize(mf.name), tag: ftag },
                    cmove: { type: capitalize(mc.type), name: capitalize(mc.name), tag: ctag }
                })
            });
        }

        // counterPokemon(stats_table['bulbasaur'].def, newPokemon['bulbasaur'].types)
        function counterPokemon(def, types) {
            let dataList = [];
            moves_Pokemon_List.forEach(value => {
                if (value.QUICK_MOVES[0] !== "STRUGGLE" && value.CINEMATIC_MOVES[0] !== "STRUGGLE") {
                    let pokemon = Object.values(newPokemon).find(item => item.num === value.ID && convertName(item.name).includes(value.NAME));
                    if (pokemon === undefined) {
                        console.log(value.ID, value.NAME);
                        return;
                    }

                    let stats = calculateStatsByTag(pokemon.baseStats, pokemon.forme);
                    value.QUICK_MOVES.forEach(vf => {
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.CINEMATIC_MOVES, "normal", "normal");
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.ELITE_CINEMATIC_MOVES, "normal", "elite");
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.SHADOW_MOVES, "normal", "shadow");
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.PURIFIED_MOVES, "normal", "purified");
                    });
                    value.ELITE_QUICK_MOVES.forEach(vf => {
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.CINEMATIC_MOVES, "elite", "normal");
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.ELITE_CINEMATIC_MOVES, "elite", "elite");
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.SHADOW_MOVES, "elite", "shadow");
                        queryMoveCounter(dataList, pokemon, stats, def, types, vf, value.PURIFIED_MOVES, "elite", "purified");
                    });
                }
                return;
            });
            return sortCounterDPS(dataList).slice(0, 100);
        }

        function sortCounterDPS(data) {
            data = data.sort((a, b) => b.dps - a.dps);
            return data.map((item, index) => ({ ...item, ratio: item.dps * 100 / data[0].dps }));
        }

        function sortOnKeys(dict) {
            var sorted = [];
            for (var key in dict) {
                sorted[sorted.length] = key;
            }
            sorted.sort();

            var tempDict = {};
            for (var i = 0; i < sorted.length; i++) {
                tempDict[sorted[i]] = dict[sorted[i]];
            }

            return tempDict;
        }

        // generate top_counters.json
        function bestAttackPokemon() {
            var dict = {};
            var count = 0;
            for (const [key, vp] of Object.entries(stats_table)) {
                if (key == "missingno") {
                    continue;
                }
                let def = vp.def;
                let types = newPokemon[key].types;
                var dictKey = types.join(",") + ":" + def;
                if (dict.hasOwnProperty(dictKey)) {
                    console.log("skipped " + newPokemon[key].name + ", " + dictKey);
                    continue;
                }
                count++;
                console.log(count + ": " + newPokemon[key].name + ", " + dictKey);
                let counters = counterPokemon(def, types);
                let uniqueCounters = new Set();
                var dictValue = [];
                for (var c of counters) {
                    //fmove: { type: capitalize(mf.type), name: capitalize(mf.name), tag: ftag },
                    var item = [c.pokemon_id, c.pokemon_key];
                    var moveItem = [c.fmove.name, c.fmove.type, c.fmove.tag, c.cmove.name, c.cmove.type, c.cmove.tag, c.ratio];
                    uniqueCounters.add(item.join(","));
                    // only take the top 10 pokemons
                    if (uniqueCounters.size > 10) {
                        console.log(dictValue.length);
                        break;
                    }
                    dictValue.push(item.concat(moveItem));
                }
                dict[dictKey] = dictValue;
            }
            dict = sortOnKeys(dict);
            console.log(JSON.stringify(dict));
        }

        window.addEventListener('load', function () {
            generateMoveOptions();

            fetch("./pokemon_go/moves_pokemon_list.json")
                .then(response => response.json())
                .then(parsed_data => {
                    moves_Pokemon_List = parsed_data;
                });

            fetch("./pokemon_go/moves.json")
                .then(response => response.json())
                .then(parsed_data => {
                    newAllMoves = parsed_data;
                });

            fetch("./pokemon_go/pokemon.json")
                .then(response => response.json())
                .then(parsed_data => {
                    newPokemon = parsed_data;

                    for (const [key, vp] of Object.entries(newPokemon)) {
                        if (key == "missingno") {
                            continue;
                        }
                        processedPokemon.push({
                            code: key,
                            label: vp.name
                        })
                    }

                    loadPokemonNames();
                });

            fetch("./pokemon_go/cp_multiplier.json")
                .then(response => response.json())
                .then(parsed_data => {
                    data_cp_multiplier = parsed_data;
                });

            fetch("./pokemon_go/dps_table.json")
                .then(response => response.json())
                .then(parsed_data => {
                    dps_table = parsed_data;
                });

            fetch("./pokemon_go/pokemon_go_options.json")
                .then(response => response.json())
                .then(parsed_data => {
                    pokemon_go_options = parsed_data;
                });

            fetch("./pokemon_go/stats_table.json")
                .then(response => response.json())
                .then(parsed_data => {
                    stats_table = parsed_data;
                });

            fetch("./pokemon_go/type_effectiveness.json")
                .then(response => response.json())
                .then(parsed_data => {
                    type_effectiveness = parsed_data;
                });

            //from calculations.html > printGroupedTopCounters
            fetch("./pokemon_go/top_counters_grouped.json")
                .then(response => response.json())
                .then(parsed_data => {
                    top_counters_grouped = parsed_data;
                });

            fetch("./pokemon_go/top_counters_pokemon_lookup.json")
                .then(response => response.json())
                .then(parsed_data => {
                    top_counters_pokemon_lookup = parsed_data;
                });
        })
    </script>
</body>

</html>