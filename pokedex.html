<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="title" content="Pokédex - All data on one page">
    <meta name="description" content="name, type, catch rate, height, weight, EV, friendship, held items, all generations, all information on one page">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Pokédex - All data on one page">
    <meta property="og:description" content="name, type, catch rate, height, weight, EV, friendship, held items, all generations, all information on one page">
    <meta property="og:image" content="./img/bdsp-calendar-apple-icon.png">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Pokédex - All data on one page">
    <meta property="twitter:description" content="name, type, catch rate, height, weight, EV, friendship, held items, all generations, all information on one page">
    <meta property="twitter:image" content="./img/bdsp-calendar-apple-icon.png">
    <link rel="shortcut icon" type="image/x-icon" href="./img/bdsp-calendar-favicon.ico">
    <link rel="apple-touch-icon" href="./img/bdsp-calendar-apple-icon.png">
    <link rel="image_src" href="./img/bdsp-calendar-apple-icon.png">
    <title>Pokédex - All data on one page</title>
    <script src="./js/sorttable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #ebf4ff;
        }

        th {
            background-color: rgb(22, 98, 141);
            color: white;
        }

        .filter-btns {
            margin: 10px;
            padding: 10px;
            line-height: 1.5em;
        }

        .filter-btns label {
            margin: 0 5px;
        }

        label {
            display: inline-block;
        }
    </style>
</head>

<body>
    <div id="filters"></div>
    <div id="pokemons"></div>
    <script>

        const filters = {
            "Gen": ["Gen 1 (1 - 151):g1",
                "Gen 2 (152 - 251):g2",
                "Gen 3 (282 - 386):g3",
                "Gen 4 (387 - 493):g4"]
        }
        const genTable = {
            "g1": [1, 151],
            "g2": [152, 251],
            "g3": [282, 386],
            "g4": [387, 493]
        }

        function addFilters() {
            var result = "";
            for (var k in filters) {
                var items = filters[k];
                result += "<div class='filter-btns " + k + "'>";
                for (var i = 0; i < items.length; i++) {
                    var key = items[i].split(":");
                    result += "<label><input type='checkbox' id='item-filter-" + key[1] + "' onclick='refresh()'>" + key[0] + "</label>";
                }
                result += "</div>";
            }
            document.querySelector("#filters").innerHTML = result;
        }

        function getSettings() {
            showItems = [];
            for (var k in filters) {
                var items = filters[k];
                for (var i = 0; i < items.length; i++) {
                    var key = items[i].split(":");
                    var checked = document.querySelector("#item-filter-" + key[1]).checked;
                    if (checked) {
                        showItems.push(key[1]);
                    }
                }
            }
            if (showItems.length == 0) {
                var q = document.location.search.substr(1);
                if (q == '') {
                    return;
                }
                var kvp = q.match(/(.{1,2})/g);
                showItems = kvp;
            }
            return showItems;
        }


        function refresh(showItems) {
            if (showItems == undefined) {
                showItems = getSettings();
            }
            console.log(showItems);
            displayP(showItems)
        }

        function setCheckBoxes() {
            var q = document.location.search.substr(1);
            if (q == '') {
                return;
            }
            var kvp = q.match(/(.{1,2})/g);
            showItems = [];
            for (var i = 0; i < kvp.length; i++) {
                var key = kvp[i];
                document.querySelector("#item-filter-" + key).checked = true;
                showItems.push(key);
            }
            refresh(showItems);
        }

        var getJSON = function (url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'json';
            xhr.onload = function () {
                var status = xhr.status;
                if (status === 200) {
                    callback(null, xhr.response);
                } else {
                    callback(status, xhr.response);
                }
            };
            xhr.send();
        };
        const pokemonTable = document.getElementById("pokemons");

        getJSON('./data/data.json',
            function (err, data) {
                if (err !== null) {
                    alert('Something went wrong: ' + err);
                } else {
                    pokemonData = data;
                    displayP();
                }
            });
        getJSON('./data/items.json',
            function (err, data) {
                if (err !== null) {
                    alert('Something went wrong: ' + err);
                } else {
                    itemsData = data;
                    displayP();
                }
            });
        var pokemonData = null;
        var itemsData = null;

        var _table_ = document.createElement('table'),
            _tr_ = document.createElement('tr'),
            _th_ = document.createElement('th'),
            _td_ = document.createElement('td');

        function buildHtmlTable(arr, order) {
            var table = _table_.cloneNode(false),
                columns = addAllColumnHeaders(arr, order, table);
            var tbody = document.createElement('tbody');
            for (var i = 0, maxi = arr.length; i < maxi; ++i) {
                var tr = _tr_.cloneNode(false);
                for (var j = 0, maxj = columns.length; j < maxj; ++j) {
                    var td = _td_.cloneNode(false);
                    cellValue = arr[i][columns[j]];
                    var d = document.createElement('span');
                    d.innerHTML = arr[i][columns[j]] || '';
                    td.appendChild(d);
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            return table;
        }

        function addAllColumnHeaders(arr, order, table) {
            var columnSet = [],
                tr = _tr_.cloneNode(false);
            var thead = document.createElement('thead');
            for (var i = 0, l = arr.length; i < l; i++) {
                for (var key in arr[i]) {
                    if (arr[i].hasOwnProperty(key) && columnSet.indexOf(key) === -1) {
                        columnSet.push(key);
                    }
                }
            }
            if (order != null && order != undefined) {
                var cs = [];
                for (var i = 0; i < order.length; i++) {
                    var ind = columnSet.indexOf(order[i]);
                    if (ind >= 0) {
                        cs.push(columnSet[ind]);
                        columnSet.splice(ind, 1);
                    }
                }
                columnSet = cs.concat(columnSet);
            }
            for (var i = 0; i < columnSet.length; i++) {
                var key = columnSet[i];
                var th = _th_.cloneNode(false);
                th.appendChild(document.createTextNode(key));
                tr.appendChild(th);
            }
            thead.appendChild(tr);
            table.appendChild(thead);
            return columnSet;
        }

        function displayP(settings) {
            pokemonTable.innerHTML = "";
            if (pokemonData == null || itemsData == null) {
                return;
            }
            if (settings == undefined) {
                settings = getSettings();
            }
            console.log(settings);
            var result = [];
            data = pokemonData;
            for (var i = 0; i < data.length; i++) {
                var di = data[i];
                var n = di["Name"];
                var fn = n;
                var on = di["OtherNames"];
                var selected = {};
                selected["No."] = di["No"];

                var canShow = false;
                if (settings.length > 0) {
                    for (var k = 0; k < settings.length; k++) {
                        if (genTable[settings[k]] != null) {
                            var mm = genTable[settings[k]];
                            if (selected["No."] <= mm[1] && selected["No."] >= mm[0]) {
                                canShow = true;
                            }
                        }
                    }
                    if (!canShow) {
                        continue;
                    }
                }

                if (on != undefined) {
                    var cn = on["Mandarin Chinese"];
                    if (cn != undefined) {
                        n = cn["Name"]["Text"];
                        n = toSimpleChinese(n);
                    }
                }
                selected["Chinese Name"] = n;
                selected["English Name"] = fn;
                var heldItem = di["HeldItems"];
                if (heldItem != undefined) {
                    var items = getHeldItems(heldItem);
                    selected["Held Items"] = items;
                }
                var stats = di["Stats"];
                if (stats != undefined) {
                    getStats(stats, selected);
                }
                var catchRate = di["CatchRate"];
                if (catchRate != undefined) {
                    selected["Catch Rate"] = catchRate["Text"];
                }
                selected["Category"] = di["Category"].replace("Pokémon", "").trim();
                var types = di["Types"];
                if (types != undefined) {
                    var keys = Object.keys(types);
                    for (var j = 0; j < keys.length; j++) {
                        if (keys[j] == "") {
                            selected["Types"] = types[""].join("; ");
                        }
                        else if (keys[j] == fn) {
                            selected["Types"] = types[fn].join("; ");
                        }
                        else {
                            selected["Other Types"] = keys[j] + ": " + types[keys[j]].join("; ") + "<br />";
                        }
                    }
                }
                result.push(selected);
            }
            var generatedTable = buildHtmlTable(result, ["No.", "Chinese Name"]);
            pokemonTable.appendChild(generatedTable);
            sorttable.makeSortable(generatedTable);
            var s = settings.join("");
            if (document.location.search.substr(1) != s) {
                console.log(document.location.search.substr(1))
                document.location.search = s;
            }
        }

        function getStats(stats, item) {
            var keys = Object.keys(stats);
            if (keys.length == 0) {
                return;
            }
            var f = keys[0];
            var f1 = stats[f];
            var ma50 = f1["MaxStatsAt50"];
            item["Max at 50 HP"] = ma50["HP"];
            item["Max at 50 Defense"] = ma50["Defense"];
            item["Max at 50 Attack"] = ma50["Attack"];
            item["Max at 50 Speed"] = ma50["Speed"];
            item["Max at 50 SpecialAttack"] = ma50["SpecialAttack"];
            item["Max at 50 SpecialDefense"] = ma50["SpecialDefense"];
            item["Max at 50 Total"] = ma50["Attack"] + ma50["HP"] + ma50["Defense"]
                + ma50["Speed"] + ma50["SpecialAttack"] + ma50["SpecialDefense"];
        }

        function getHeldItems(heldItem) {
            var items = [];
            for (var j = 0; j < heldItem.length; j++) {
                var hi = heldItem[j];
                var gen = hi["Games"];
                if (gen == undefined) {
                    return "gen = undefined";
                }
                if (gen.indexOf("diamond") >= 0) {
                    var ns = hi["Name"];
                    var ps = hi["Probability"];
                    for (var o = 0; o < itemsData.length; o++) {
                        var io = itemsData[o]["Name"];
                        if (io == ns || io.replace(/[ \-]/g, "") == ns) {
                            ns = itemsData[o]["OtherNames"]["Mandarin Chinese"]["Name"]["Text"];
                            ns = toSimpleChinese(ns);
                        }
                    }
                    items.push(ns + ps);
                }
            }
            return items.join("; ");
        }

        function toSimpleChinese(t) {
            if (t.indexOf("/") >= 0) {
                return t.split("/")[1].trim();
            }
            return t;
        }

        addFilters();
        setCheckBoxes();
    </script>
</body>

</html>